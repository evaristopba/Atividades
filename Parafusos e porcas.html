<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Parafusos e Porcas - Completo</title>
<style>
/* =====================================================
   ESTILOS GLOBAIS
   ===================================================== */

/* Remove a sele√ß√£o de texto e define box-sizing para todos os elementos */
* {
  box-sizing: border-box;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  -webkit-user-drag: none;
  user-drag: none;
}

/* Configura√ß√£o do html e body para ocupar toda a tela sem rolagem */
html, body {
  height: 100%;
  margin: 0;
  padding: 10px;
  overflow: hidden;
}

/* Estilo principal do body com gradiente de fundo */
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
  text-align: center;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

/* =====================================================
   PROTE√á√ÉO CONTRA CLIQUES ACIDENTAIS
   ===================================================== */

/* Garante que elementos interativos funcionem */
.screw, button, select, .close-btn, .info-item, .nivel-badge, .desafio-info, #sequencia-info {
  pointer-events: auto !important;
  cursor: pointer;
}

/* √Åreas do jogo mant√™m interatividade */
#board, #topbar, .modal-content {
  pointer-events: auto;
}

/* Impede cliques no body de afetarem o app */
body {
  pointer-events: none;
}

/* Libera os filhos do body que s√£o interativos */
body > * {
  pointer-events: auto;
}

/* Estilo do t√≠tulo principal */
h1 {
  color: white;
  margin: 5px 0 10px;
  font-size: 2rem;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
  flex-shrink: 0;
}

/* =====================================================
   BARRA SUPERIOR (TOPBAR)
   ===================================================== */

/* Container da topbar com fundo semi-transparente */
#topbar {
  background: rgba(255, 255, 255, 0.95);
  padding: 8px 12px;
  border-radius: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 10px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(10px);
  border: 2px solid #f1c40f;
  flex-shrink: 0;
  min-height: 48px;
}

/* Estilo comum para itens de informa√ß√£o na topbar */
.info-item, .nivel-badge, .desafio-info, #sequencia-info {
  background: #ecf0f1;
  padding: 4px 10px;
  border-radius: 30px;
  font-weight: 700;
  color: #2c3e50;
  box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
  font-size: 0.85rem;
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  gap: 3px;
  line-height: 1.2;
  position: relative;
}

/* Tooltips para elementos da topbar - aparecem ao passar o mouse */
.info-item[title]:hover::after, 
.nivel-badge[title]:hover::after, 
.desafio-info[title]:hover::after, 
#sequencia-info[title]:hover::after,
button[title]:hover::after {
  content: attr(title);
  position: absolute;
  bottom: 125%;
  left: 50%;
  transform: translateX(-50%);
  background: #2c3e50;
  color: white;
  padding: 4px 8px;
  border-radius: 15px;
  font-size: 0.7rem;
  white-space: nowrap;
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  border: 1px solid #f1c40f;
  z-index: 1000;
  pointer-events: none;
}

/* Seta do tooltip */
.info-item[title]:hover::before,
.nivel-badge[title]:hover::before,
.desafio-info[title]:hover::before,
#sequencia-info[title]:hover::before,
button[title]:hover::before {
  content: '';
  position: absolute;
  bottom: 115%;
  left: 50%;
  transform: translateX(-50%);
  border-width: 5px;
  border-style: solid;
  border-color: #2c3e50 transparent transparent transparent;
  z-index: 1000;
  pointer-events: none;
}

/* =====================================================
   BOT√ïES
   ===================================================== */

/* Estilo base para bot√µes e selects */
button, select {
  padding: 4px 10px;
  border-radius: 30px;
  border: none;
  background: #3498db;
  font-weight: 700;
  cursor: pointer;
  color: white;
  font-size: 0.85rem;
  box-shadow: 0 2px 0 #2980b9, 0 3px 6px rgba(0, 0, 0, 0.2);
  transition: all 0.1s;
  white-space: nowrap;
  line-height: 1.2;
  position: relative;
}

/* Efeito hover para bot√µes */
button:hover, select:hover {
  background: #2980b9;
  transform: translateY(-1px);
  box-shadow: 0 3px 0 #1f618d, 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* Efeito active (clique) para bot√µes */
button:active {
  transform: translateY(2px);
  box-shadow: 0 1px 0 #1f618d;
}

/* =====================================================
   TABULEIRO (PARAFUSOS)
   ===================================================== */

/* Grid do tabuleiro com 6 colunas */
#board {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 8px;
  max-width: 1000px;
  margin: 0 auto;
  width: 100%;
  flex: 1;
  min-height: 0;
  overflow: hidden;
}

/* Estilo de cada parafuso */
.screw {
  background: linear-gradient(145deg, #bdc3c7, #95a5a6);
  border-radius: 18px 18px 6px 6px;
  padding: 4px 2px 6px;
  height: 100%;
  max-height: 180px;
  display: flex;
  flex-direction: column-reverse;
  align-items: center;
  justify-content: flex-start;
  border: 3px solid #7f8c8d;
  box-shadow: 0 4px 0 #4a5a5a, 0 6px 10px rgba(0, 0, 0, 0.4);
  position: relative;
  cursor: pointer;
  transition: all 0.1s;
  background-image: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.3) 0%, transparent 30%);
}

/* Cabe√ßa do parafuso (parte inferior) */
.screw::after {
  content: "";
  position: absolute;
  bottom: -2px;
  left: 50%;
  transform: translateX(-50%);
  width: 30px;
  height: 10px;
  background: linear-gradient(90deg, #7f8c8d, #4a5a5a, #7f8c8d);
  border-radius: 4px 4px 0 0;
  border: 2px solid #2c3e50;
  border-bottom: none;
  box-shadow: inset 0 2px 2px rgba(0, 0, 0, 0.3);
}

/* Parafuso selecionado (destaque laranja) */
.screw.selected {
  border: 4px solid #f1c40f;
  box-shadow: 0 0 0 3px #f7dc6f, 0 4px 0 #b7950b;
}

/* Parafuso que faz parte da sequ√™ncia (destaque laranja brilhante) */
.screw.sequencia {
  border: 3px solid #f39c12;
  box-shadow: 0 0 8px #f39c12, 0 4px 0 #b7950b;
  animation: pulse 1.5s infinite;
}

/* Anima√ß√£o de pulsar para a sequ√™ncia */
@keyframes pulse {
  0% { border-color: #f39c12; }
  50% { border-color: #f1c40f; }
  100% { border-color: #f39c12; }
}

/* =====================================================
   PORCAS (FORMATO HEXAGONAL)
   ===================================================== */

/* Estilo base de cada porca */
.nut {
  width: 32px;
  height: 32px;
  margin: 1px 0;
  border: 2px solid #2c3e50;
  box-shadow: 0 2px 0 #1a2632, 0 3px 5px rgba(0, 0, 0, 0.3);
  transition: 0.05s;
  flex-shrink: 0;
  background: linear-gradient(145deg, #ecf0f1, #bdc3c7);
  clip-path: polygon(25% 0%, 75% 0%, 100% 25%, 100% 75%, 75% 100%, 25% 100%, 0% 75%, 0% 25%);
  position: relative;
}

/* Furo central da porca */
.nut::after {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 12px;
  height: 12px;
  background: linear-gradient(145deg, #7f8c8d, #4a5a5a);
  border-radius: 50%;
  border: 2px solid #2c3e50;
}

/* Detalhe dourado no centro (simula metal) */
.nut::before {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 4px;
  height: 4px;
  background: #f1c40f;
  border-radius: 50%;
  z-index: 2;
  border: 1px solid #b7950b;
}

/* Placeholder invis√≠vel para manter o tamanho dos parafusos */
.nut-placeholder {
  width: 32px;
  height: 32px;
  margin: 1px 0;
  visibility: hidden;
  flex-shrink: 0;
}

/* =====================================================
   PARAFUSOS COMPLETOS (LOCKED)
   ===================================================== */

/* Estilo para parafuso completo (verde) */
.locked {
  border: 3px solid #27ae60 !important;
  background: linear-gradient(145deg, #d5f5e3, #a9dfbf) !important;
  box-shadow: 0 4px 0 #1e8449, 0 6px 10px rgba(0, 0, 0, 0.3) !important;
}

/* Check de confirma√ß√£o no parafuso completo */
.locked::after {
  content: "‚úì";
  position: absolute;
  top: -4px;
  right: -4px;
  background: #27ae60;
  color: white;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 11px;
  border: 2px solid #f1c40f;
  z-index: 10;
}

/* =====================================================
   BARRA DE PROGRESSO
   ===================================================== */

/* Container da barra de progresso */
#progress-bar {
  width: 100px;
  height: 8px;
  background: #ecf0f1;
  border-radius: 20px;
  overflow: hidden;
  border: 1px solid #2980b9;
  flex-shrink: 0;
}

/* Preenchimento da barra de progresso */
#progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #27ae60, #2ecc71);
  width: 0%;
  transition: width 0.3s;
}

/* =====================================================
   FEEDBACK (MENSAGENS FLUTUANTES)
   ===================================================== */

/* Mensagens tempor√°rias que aparecem na tela */
.feedback {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #2c3e50;
  color: white;
  padding: 8px 20px;
  border-radius: 30px;
  font-size: 0.9rem;
  font-weight: bold;
  box-shadow: 0 5px 15px black;
  z-index: 1000;
  border: 2px solid #f1c40f;
}

/* =====================================================
   ESTILOS PARA A COMEMORA√á√ÉO
   ===================================================== */

/* Container da comemora√ß√£o (ocupa toda a tela) */
#celebracao {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none; /* N√£o atrapalha cliques */
  z-index: 9999;
  display: none;
}

/* Confetes individuais */
.confete {
  position: absolute;
  width: 10px;
  height: 20px;
  background: linear-gradient(45deg, #f1c40f, #f39c12);
  border-radius: 2px;
  animation: cair 3s linear forwards;
}

/* Cores variadas para os confetes */
.confete:nth-child(1) { background: #e74c3c; left: 10%; animation-delay: 0s; }
.confete:nth-child(2) { background: #3498db; left: 20%; animation-delay: 0.2s; }
.confete:nth-child(3) { background: #2ecc71; left: 30%; animation-delay: 0.4s; }
.confete:nth-child(4) { background: #f1c40f; left: 40%; animation-delay: 0.6s; }
.confete:nth-child(5) { background: #9b59b6; left: 50%; animation-delay: 0.8s; }
.confete:nth-child(6) { background: #e67e22; left: 60%; animation-delay: 1s; }
.confete:nth-child(7) { background: #1abc9c; left: 70%; animation-delay: 1.2s; }
.confete:nth-child(8) { background: #e74c3c; left: 80%; animation-delay: 1.4s; }
.confete:nth-child(9) { background: #3498db; left: 90%; animation-delay: 1.6s; }
.confete:nth-child(10) { background: #f1c40f; left: 95%; animation-delay: 1.8s; }
.confete:nth-child(11) { background: #2ecc71; left: 15%; animation-delay: 2s; }
.confete:nth-child(12) { background: #9b59b6; left: 25%; animation-delay: 2.2s; }
.confete:nth-child(13) { background: #e67e22; left: 35%; animation-delay: 2.4s; }
.confete:nth-child(14) { background: #1abc9c; left: 45%; animation-delay: 2.6s; }
.confete:nth-child(15) { background: #e74c3c; left: 55%; animation-delay: 2.8s; }

/* Anima√ß√£o de cair */
@keyframes cair {
  0% {
    top: -10%;
    transform: rotate(0deg);
    opacity: 1;
  }
  100% {
    top: 110%;
    transform: rotate(360deg);
    opacity: 0.8;
  }
}

/* Mensagem de parab√©ns */
#mensagem-parabens {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.8);
  color: #f1c40f;
  font-size: 3rem;
  font-weight: bold;
  padding: 20px 40px;
  border-radius: 60px;
  border: 4px solid #f1c40f;
  box-shadow: 0 0 50px rgba(241, 196, 15, 0.5);
  z-index: 10000;
  text-align: center;
  animation: pulsar 0.5s ease-in-out infinite alternate;
  display: none;
}

/* Anima√ß√£o de pulsar */
@keyframes pulsar {
  from {
    transform: translate(-50%, -50%) scale(1);
    text-shadow: 0 0 20px #f1c40f;
  }
  to {
    transform: translate(-50%, -50%) scale(1.1);
    text-shadow: 0 0 40px #f39c12;
  }
}

/* Estrelas brilhantes */
.estrela {
  position: fixed;
  width: 4px;
  height: 4px;
  background: white;
  border-radius: 50%;
  animation: brilhar 1s infinite alternate;
}

@keyframes brilhar {
  from {
    opacity: 0.3;
    transform: scale(1);
  }
  to {
    opacity: 1;
    transform: scale(1.5);
  }
}

/* =====================================================
   MODAIS (INSTRU√á√ïES, BNCC, PROFESSOR)
   ===================================================== */

/* Estilo base para todos os modais (telas sobrepostas) */
#instructions, #teacherPanel, #bnccModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(5px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

/* Conte√∫do dos modais */
.modal-content {
  background: white;
  padding: 20px;
  border-radius: 25px;
  max-width: 450px;
  max-height: 80vh;
  overflow-y: auto;
  border: 4px solid #f1c40f;
  text-align: left;
}

/* Bot√£o de fechar modal */
.close-btn {
  float: right;
  background: #e74c3c;
  color: white;
  border: none;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  font-size: 15px;
  cursor: pointer;
  border: 2px solid #c0392b;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-btn:hover {
  background: #c0392b;
}

/* Campo de entrada para senha do professor */
.teacher-input {
  padding: 5px;
  font-size: 0.9rem;
  border-radius: 30px;
  border: 2px solid #2c3e50;
  width: 150px;
  text-align: center;
  margin-bottom: 8px;
}

/* Bot√£o de diagn√≥stico no painel do professor */
.diagnostico-btn {
  background: #e67e22;
  margin-top: 10px;
  width: 100%;
  font-size: 0.85rem;
  padding: 6px;
}

.diagnostico-btn:hover {
  background: #d35400;
}

/* Se√ß√µes dentro do modal BNCC */
.bncc-section {
  background: #ecf0f1;
  border-radius: 12px;
  padding: 10px;
  margin: 10px 0;
  border-left: 5px solid #27ae60;
}

.bncc-section h3 {
  color: #27ae60;
  margin-top: 0;
  font-size: 1rem;
}

/* C√≥digos da BNCC */
.bncc-code {
  background: #2c3e50;
  color: white;
  padding: 2px 6px;
  border-radius: 20px;
  display: inline-block;
  font-weight: bold;
  margin: 2px 0;
  font-size: 0.8rem;
}
</style>
</head>
<body>

<h1>üîß PARAFUSOS E PORCAS üî©</h1>

<!-- =====================================================
     BARRA SUPERIOR (TOPBAR) - COM BOT√ÉO BNCC
     ===================================================== -->
<div id="topbar">
  <!-- Informa√ß√µes do jogo -->
  <div class="info-item" title="Pontua√ß√£o total">‚≠ê <span id="score">0</span></div>
  <div class="info-item" title="N√∫mero de movimentos realizados">üîÑ <span id="moves">0</span></div>
  <div class="info-item" title="Parafusos completos na rodada atual">üîí <span id="completosRodada">0</span>/<span id="metaRodada">6</span></div>
  <div class="nivel-badge" id="nivelAtual" title="N√≠vel atual">N√≠vel 1</div>
  <div class="desafio-info" id="desafioAtual" title="Rodada atual / Total de rodadas">Rodada 1/10</div>
  <div id="sequencia-info" title="Maior sequ√™ncia de parafusos completos consecutivos">üèÜ Sequ√™ncia: <span id="sequenciaTamanho">0</span></div>
  <div id="progress-bar" title="Progresso da rodada atual"><div id="progress-fill"></div></div>
  
  <!-- Bot√µes de a√ß√£o -->
  <button onclick="gerarCodigo()" title="Gerar c√≥digo num√©rico (13 d√≠gitos) para continuar depois">üìã Gerar C√≥digo</button>
  <button onclick="restaurarCodigo()" title="Restaurar progresso digitando o c√≥digo (12 ou 13 d√≠gitos)">üîÑ Restaurar</button>
  <button onclick="desfazer()" title="Desfazer o √∫ltimo movimento">‚Ü©Ô∏è Desfazer</button>
  <button onclick="mostrarInstrucoes()" title="Ver instru√ß√µes do jogo">üìò Ajuda</button>
  <button onclick="mostrarBNCC()" title="Habilidades da BNCC desenvolvidas">üìö BNCC</button>
  <button onclick="mostrarPainelProfessor()" title="Abrir painel do professor">üë®‚Äçüè´ Professor</button>
</div>

<!-- =====================================================
     TABULEIRO DO JOGO
     ===================================================== -->
<div id="board"></div>

<!-- =====================================================
     ELEMENTOS DE COMEMORA√á√ÉO
     ===================================================== -->
<div id="celebracao"></div>
<div id="mensagem-parabens"></div>

<!-- =====================================================
     MODAL DE INSTRU√á√ïES
     ===================================================== -->
<div id="instructions">
  <div class="modal-content">
    <button class="close-btn" onclick="fecharInstrucoes()" title="Fechar">‚úï</button>
    <h2 style="margin-top:0; color:#2c3e50;">üìò COMO JOGAR</h2>
    
    <h3>üéØ Objetivo</h3>
    <p>Organize todas as porcas coloridas em parafusos, formando pilhas de <strong>4 porcas da mesma cor</strong>.</p>
    
    <h3>üéÆ Regras</h3>
    <ul>
      <li><strong>Clique</strong> em um parafuso para selecionar a porca do <strong>TOPO</strong></li>
      <li><strong>Clique</strong> em outro parafuso para mover a porca</li>
      <li>S√≥ pode mover se o destino estiver <strong>vazio</strong> ou com a <strong>mesma cor</strong> no topo</li>
      <li>Cada parafuso suporta no m√°ximo <strong>4 porcas</strong></li>
      <li><strong>üö´ Parafusos completos n√£o podem ser movidos!</strong></li>
    </ul>
    
    <h3>üìã C√ìDIGO DE RESTAURA√á√ÉO (13 D√çGITOS)</h3>
    <ul>
      <li><strong>üìå No final da aula</strong>, clique em "Gerar C√≥digo"</li>
      <li><strong>‚úèÔ∏è Anote o n√∫mero no caderno</strong> (13 d√≠gitos, s√≥ n√∫meros!)</li>
      <li><strong>üîÑ Na pr√≥xima aula</strong>, clique em "Restaurar" e digite o n√∫mero</li>
      <li>‚úÖ C√≥digos antigos de 12 d√≠gitos tamb√©m funcionam!</li>
    </ul>
    
    <h3>üìä Formato do c√≥digo:</h3>
    <ul>
      <li><strong>3 d√≠gitos:</strong> N√≠vel (001 a 003)</li>
      <li><strong>2 d√≠gitos:</strong> Rodada (01 a 35)</li>
      <li><strong>3 d√≠gitos:</strong> Movimentos (000 a 999)</li>
      <li><strong>5 d√≠gitos:</strong> Pontos (00000 a 99999)</li>
    </ul>
    
    <h3>üèÜ B√îNUS DE SEQU√äNCIA (ACUMULATIVO)</h3>
    <ul>
      <li><strong>Sequ√™ncia perfeita:</strong> parafusos completos em ordem crescente (1,2,3...)</li>
      <li><strong>Sem vazios:</strong> n√£o pode haver parafusos vazios entre eles</li>
      <li><strong>Pontua√ß√£o acumulativa:</strong></li>
      <ul>
        <li>‚úÖ Sequ√™ncia de 3 ‚Üí +50 pontos</li>
        <li>‚úÖ Sequ√™ncia de 4 ‚Üí +100 pontos (total 150)</li>
        <li>‚úÖ Sequ√™ncia de 5 ‚Üí +200 pontos (total 350)</li>
        <li>‚úÖ Sequ√™ncia de 6 ‚Üí +200 pontos (total 550)</li>
        <li>‚úÖ Quanto maior a sequ√™ncia, mais pontos voc√™ acumula!</li>
      </ul>
      <li><strong>üéØ DICA:</strong> Tente sempre aumentar sua maior sequ√™ncia ‚Äì a pontua√ß√£o sobe r√°pido e √© muito gratificante!</li>
      <li><em>‚ÄúAprender brincando √© a forma mais eficaz de fixar o conhecimento!‚Äù</em></li>
    </ul>
    
    <h3>üìä Progress√£o</h3>
    <ul>
      <li><strong>N√≠vel 1:</strong> 6 cores | 10 rodadas | meta: 6 parafusos/rodada</li>
      <li><strong>N√≠vel 2:</strong> 9 cores | 20 rodadas | meta: 9 parafusos/rodada</li>
      <li><strong>N√≠vel 3:</strong> 12 cores | 35 rodadas | meta: 12 parafusos/rodada</li>
    </ul>
  </div>
</div>

<!-- =====================================================
     MODAL BNCC
     ===================================================== -->
<div id="bnccModal">
  <div class="modal-content">
    <button class="close-btn" onclick="fecharBNCC()" title="Fechar">‚úï</button>
    <h2 style="margin-top:0; color:#2c3e50;">üìö BASE NACIONAL COMUM CURRICULAR</h2>
    
    <div class="bncc-section">
      <h3>üå± EDUCA√á√ÉO INFANTIL</h3>
      <p><strong>Campo de Experi√™ncia:</strong> Espa√ßos, tempos, quantidades, rela√ß√µes e transforma√ß√µes</p>
      <span class="bncc-code">EI03ET01</span> Estabelecer rela√ß√µes de compara√ß√£o entre objetos<br>
      <span class="bncc-code">EI03ET05</span> Classificar objetos e figuras de acordo com suas propriedades
    </div>
    
    <div class="bncc-section">
      <h3>üìê ENSINO FUNDAMENTAL - MATEM√ÅTICA</h3>
      <p><strong>Unidade Tem√°tica:</strong> Probabilidade e estat√≠stica / Grandezas e medidas</p>
      <span class="bncc-code">EF01MA09</span> Organizar e ordenar objetos familiares<br>
      <span class="bncc-code">EF02MA18</span> Indicar a dire√ß√£o e sentido em deslocamentos<br>
      <span class="bncc-code">EF03MA25</span> Identificar regularidades em sequ√™ncias
    </div>
    
    <div class="bncc-section">
      <h3>üß† HABILIDADES DESENVOLVIDAS</h3>
      <ul>
        <li><strong>Racioc√≠nio l√≥gico:</strong> planejar movimentos para atingir o objetivo</li>
        <li><strong>Classifica√ß√£o:</strong> agrupar porcas por cor</li>
        <li><strong>Sequencia√ß√£o:</strong> ordem de empilhamento (base ao topo)</li>
        <li><strong>Resolu√ß√£o de problemas:</strong> encontrar solu√ß√µes para completar os parafusos</li>
        <li><strong>Persist√™ncia:</strong> completar m√∫ltiplas rodadas e n√≠veis</li>
      </ul>
    </div>
    
    <p style="font-style: italic; color: #27ae60; text-align: center;">"Aprender brincando √© a forma mais eficaz de fixar o conhecimento!"</p>
  </div>
</div>

<!-- =====================================================
     MODAL DO PROFESSOR
     ===================================================== -->
<div id="teacherPanel">
  <div class="modal-content">
    <button class="close-btn" onclick="fecharPainelProfessor()" title="Fechar">‚úï</button>
    <h2 style="margin-top:0; color:#2c3e50;">üë®‚Äçüè´ PAINEL DO PROFESSOR</h2>
    
    <p>üîì <strong>Desbloquear n√≠veis:</strong></p>
    <input type="password" id="senhaInput" class="teacher-input" placeholder="Digite a senha" maxlength="5">
    <div style="margin: 15px 0; text-align: center;">
      <button onclick="verificarSenha(1)" style="margin:3px;" title="Desbloquear N√≠vel 1 (6 cores)">üîì N√≠vel 1</button>
      <button onclick="verificarSenha(2)" style="margin:3px;" title="Desbloquear N√≠vel 2 (9 cores)">üîì N√≠vel 2</button>
      <button onclick="verificarSenha(3)" style="margin:3px;" title="Desbloquear N√≠vel 3 (12 cores)">üîì N√≠vel 3</button>
    </div>
    
    <hr style="margin: 20px 0; border: 1px solid #ecf0f1;">
    
    <p>üîç <strong>Ferramentas de diagn√≥stico:</strong></p>
    <button onclick="diagnosticar()" class="diagnostico-btn" title="Mostra a contagem de cada cor no tabuleiro">üìä Diagnosticar distribui√ß√£o de cores</button>
    <p style="font-size: 0.85rem; color: #7f8c8d; margin-top: 10px;">
      Mostra quantas porcas de cada cor existem no tabuleiro atual
    </p>
  </div>
</div>

<script>
// =====================================================
// CONSTANTES E CONFIGURA√á√ïES
// =====================================================

// Array com todas as cores dispon√≠veis no jogo (15 cores no total)
const CORES = [
  "#ef4444", // Vermelho
  "#3b82f6", // Azul
  "#22c55e", // Verde
  "#f59e0b", // Laranja
  "#a855f7", // Roxo
  "#ec4899", // Rosa
  "#14b8a6", // Turquesa
  "#f97316", // Laranja escuro
  "#8b5cf6", // Violeta
  "#06b6d4", // Ciano
  "#d946ef", // Magenta
  "#84cc16", // Lima
  "#f43f5e", // Ros√™
  "#10b981", // Esmeralda
  "#6366f1"  // √çndigo
];

// Mapeamento de cores hexadecimais para nomes leg√≠veis (usado nos tooltips)
const NOMES_CORES = {
  "#ef4444": "Vermelho",
  "#3b82f6": "Azul",
  "#22c55e": "Verde",
  "#f59e0b": "Laranja",
  "#a855f7": "Roxo",
  "#ec4899": "Rosa",
  "#14b8a6": "Turquesa",
  "#f97316": "Laranja escuro",
  "#8b5cf6": "Violeta",
  "#06b6d4": "Ciano",
  "#d946ef": "Magenta",
  "#84cc16": "Lima",
  "#f43f5e": "Ros√™",
  "#10b981": "Esmeralda",
  "#6366f1": "√çndigo"
};

// Capacidade m√°xima de porcas por parafuso
const CAPACIDADE = 4;

// Senha para desbloquear n√≠veis no painel do professor (ALTERADA PARA X2026)
const SENHA_PROFESSOR = "X2026";

// Configura√ß√£o dos n√≠veis do jogo
// Cada n√≠vel define: quantidade de cores, total de rodadas, b√¥nus ao completar
const CONFIG = {
  1: { cores: 6, totalRodadas: 10, bonus: 100, completa: false },
  2: { cores: 9, totalRodadas: 20, bonus: 200, completa: false },
  3: { cores: 12, totalRodadas: 35, bonus: 400, completa: false }
};

// =====================================================
// ESTADO GLOBAL DO JOGO
// =====================================================

// N√≠vel atual (1, 2 ou 3)
let nivelAtual = 1;

// Rodada atual dentro do n√≠vel
let rodadaAtual = 1;

// Matriz que representa todos os parafusos e suas porcas
// Cada parafuso √© um array de cores, onde o √∫ltimo elemento √© o topo
let parafusos = [];

// Hist√≥rico de estados para permitir desfazer movimentos
let historico = [];

// Contador de movimentos realizados
let movimentos = 0;

// Pontua√ß√£o total do jogador
let pontos = 0;

// √çndice do parafuso atualmente selecionado (null = nenhum)
let selecionado = null;

// Flag que indica se est√° processando a transi√ß√£o entre rodadas
// Usado para evitar cliques durante a anima√ß√£o
let processandoRodada = false;

// Array com os √≠ndices dos parafusos que fazem parte da maior sequ√™ncia atual
let ultimaSequencia = [];

// =====================================================
// FUN√á√ïES DE C√ìDIGO (ATUALIZADO PARA 13 D√çGITOS)
// =====================================================

/**
 * Gera um c√≥digo num√©rico de 13 d√≠gitos representando o progresso atual
 * Formato: NNN RR MMM PPPPP (3+2+3+5 = 13 d√≠gitos)
 * - NNN: N√≠vel (001 a 003)
 * - RR: Rodada (01 a 35)
 * - MMM: Movimentos (000 a 999)
 * - PPPPP: Pontos (00000 a 99999)
 */
function gerarCodigo() {
  // Converte cada valor para string com zeros √† esquerda para garantir o n√∫mero fixo de d√≠gitos
  let nivelStr = nivelAtual.toString().padStart(3, '0');
  let rodadaStr = rodadaAtual.toString().padStart(2, '0');
  let movStr = movimentos.toString().padStart(3, '0');
  let pontosStr = pontos.toString().padStart(5, '0');
  
  // C√≥digo sem espa√ßos (13 d√≠gitos concatenados)
  let codigo = nivelStr + rodadaStr + movStr + pontosStr;
  
  // Vers√£o formatada com espa√ßos para facilitar a leitura e anota√ß√£o
  let codigoFormatado = `${nivelStr} ${rodadaStr} ${movStr} ${pontosStr}`;
  
  // Prepara mensagem para o aluno com formato de caixa de texto
  let mensagem = "";
  mensagem += "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n";
  mensagem += "‚ïë   C√ìDIGO DE RESTAURA√á√ÉO       ‚ïë\n";
  mensagem += "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n";
  mensagem += "‚ïë                                 ‚ïë\n";
  mensagem += "‚ïë     üìù " + codigoFormatado + "     ‚ïë\n";
  mensagem += "‚ïë                                 ‚ïë\n";
  mensagem += "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n";
  mensagem += "‚ïë N√≠vel: " + nivelAtual + "  Rodada: " + rodadaAtual + "/" + getTotalRodadas() + "\n";
  mensagem += "‚ïë Pontos: " + pontos + "  Movimentos: " + movimentos + "\n";
  mensagem += "‚ïë Parafusos: " + contarCompletos() + "/18\n";
  mensagem += "‚ïë                                 ‚ïë\n";
  mensagem += "‚ïë ANOTE NO CADERNO!               ‚ïë\n";
  mensagem += "‚ïë S√£o 13 n√∫meros.                  ‚ïë\n";
  mensagem += "‚ïë C√≥digos antigos de 12 n√∫meros   ‚ïë\n";
  mensagem += "‚ïë tamb√©m funcionam!                ‚ïë\n";
  mensagem += "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù";
  
  // Exibe a mensagem para o aluno
  alert(mensagem);
  
  // Tenta copiar o c√≥digo para a √°rea de transfer√™ncia automaticamente
  // Isso ajuda se o aluno estiver em um computador com acesso a um caderno digital
  try {
    navigator.clipboard.writeText(codigo);
    alert("üìã C√≥digo copiado para √°rea de transfer√™ncia!");
  } catch (e) {
    // Se n√£o conseguir copiar (navegador n√£o permite), apenas ignora
    // O aluno ainda pode anotar manualmente
  }
}

/**
 * Restaura o progresso do jogo a partir de um c√≥digo digitado pelo usu√°rio
 * Aceita tanto c√≥digos antigos de 12 d√≠gitos quanto novos de 13 d√≠gitos
 */
function restaurarCodigo() {
  // Solicita que o aluno digite o c√≥digo
  let codigo = prompt("Digite o c√≥digo (12 ou 13 n√∫meros):");
  if (!codigo) return; // Se cancelar, sai da fun√ß√£o
  
  // Remove espa√ßos, tra√ßos, pontos que o aluno possa ter adicionado para facilitar a leitura
  codigo = codigo.replace(/[-\s.]/g, '');
  
  // =====================================================
  // COMPATIBILIDADE COM C√ìDIGOS ANTIGOS (12 D√çGITOS)
  // =====================================================
  if (codigo.length === 12) {
    // Formato antigo: NNN RR MMM PPPP (3+2+3+4 = 12 d√≠gitos)
    let nivel = parseInt(codigo.substring(0, 3));
    let rodada = parseInt(codigo.substring(3, 5));
    let mov = parseInt(codigo.substring(5, 8));
    let pts = parseInt(codigo.substring(8, 12));
    
    // Valida√ß√£o dos valores extra√≠dos
    if (nivel >= 1 && nivel <= 3 && 
        rodada >= 1 && rodada <= CONFIG[nivel].totalRodadas &&
        mov >= 0 && mov <= 999 &&
        pts >= 0 && pts <= 9999) {
      
      // Restaura o estado do jogo
      nivelAtual = nivel;
      rodadaAtual = rodada;
      movimentos = mov;
      pontos = pts;
      
      // Gera um novo tabuleiro e redesenha
      gerarTabuleiro();
      desenhar();
      
      feedback("‚úÖ C√≥digo antigo (12 d√≠gitos) restaurado com sucesso!");
      return;
    } else {
      feedback("‚ùå C√≥digo inv√°lido!");
      return;
    }
  }
  
  // =====================================================
  // FORMATO NOVO (13 D√çGITOS)
  // =====================================================
  if (codigo.length === 13) {
    // Verifica se o c√≥digo cont√©m apenas n√∫meros
    if (!/^\d+$/.test(codigo)) {
      feedback("‚ùå C√≥digo deve conter apenas n√∫meros!");
      return;
    }
    
    // Extrai as partes do c√≥digo
    let nivel = parseInt(codigo.substring(0, 3));
    let rodada = parseInt(codigo.substring(3, 5));
    let mov = parseInt(codigo.substring(5, 8));
    let pts = parseInt(codigo.substring(8, 13));
    
    // Valida os valores extra√≠dos
    if (nivel < 1 || nivel > 3) {
      feedback("‚ùå N√≠vel inv√°lido! Deve ser 1, 2 ou 3.");
      return;
    }
    
    let totalRodadas = CONFIG[nivel].totalRodadas;
    if (rodada < 1 || rodada > totalRodadas) {
      feedback("‚ùå Rodada deve ser entre 1 e " + totalRodadas + "!");
      return;
    }
    
    if (mov < 0 || mov > 999) {
      feedback("‚ùå Movimentos inv√°lidos! M√°ximo 999.");
      return;
    }
    
    if (pts < 0 || pts > 99999) {
      feedback("‚ùå Pontua√ß√£o inv√°lida! M√°ximo 99.999.");
      return;
    }
    
    // Restaura o estado do jogo
    nivelAtual = nivel;
    rodadaAtual = rodada;
    movimentos = mov;
    pontos = pts;
    
    // Gera um novo tabuleiro e redesenha
    gerarTabuleiro();
    desenhar();
    
    feedback("‚úÖ Progresso restaurado com sucesso!");
    return;
  }
  
  // Se chegou aqui, o c√≥digo tem tamanho diferente de 12 ou 13 d√≠gitos
  feedback("‚ùå C√≥digo deve ter 12 ou 13 n√∫meros!");
}

// =====================================================
// FUN√á√ïES AUXILIARES
// =====================================================

/**
 * Embaralha um array usando o algoritmo Fisher-Yates
 * @param {Array} arr - O array a ser embaralhado
 * @returns {Array} O mesmo array embaralhado (modifica o original)
 */
function embaralhar(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

/**
 * Retorna a quantidade de cores do n√≠vel atual
 * @returns {number} N√∫mero de cores (6, 9 ou 12)
 */
function getQtdCores() {
  return CONFIG[nivelAtual].cores;
}

/**
 * Retorna a meta de parafusos para a rodada atual
 * A meta √© igual ao n√∫mero de cores do n√≠vel
 * @returns {number} Quantos parafusos precisam ser completados
 */
function getMetaRodada() {
  return getQtdCores();
}

/**
 * Retorna o total de rodadas do n√≠vel atual
 * @returns {number} Total de rodadas (10, 20 ou 35)
 */
function getTotalRodadas() {
  return CONFIG[nivelAtual].totalRodadas;
}

/**
 * Retorna o b√¥nus por completar o n√≠vel atual
 * @returns {number} B√¥nus (100, 200 ou 400)
 */
function getBonus() {
  return CONFIG[nivelAtual].bonus;
}

/**
 * Fun√ß√£o de diagn√≥stico para o professor
 * Mostra um alerta com a contagem de cada cor no tabuleiro atual
 * √ötil para verificar se a distribui√ß√£o de porcas est√° correta
 */
function diagnosticar() {
  let qtdCores = getQtdCores();
  let contagem = {};
  
  // Inicializa contagem para cada cor do n√≠vel
  for (let i = 0; i < qtdCores; i++) {
    contagem[CORES[i]] = 0;
  }
  
  // Conta as porcas de cada cor em todos os parafusos
  for (let i = 0; i < 18; i++) {
    for (let j = 0; j < parafusos[i].length; j++) {
      let cor = parafusos[i][j];
      if (contagem[cor] !== undefined) {
        contagem[cor]++;
      }
    }
  }
  
  // Prepara a mensagem com os resultados
  let msg = "üìä DIAGN√ìSTICO - CORES NO TABULEIRO:\n\n";
  for (let i = 0; i < qtdCores; i++) {
    let cor = CORES[i];
    let nome = NOMES_CORES[cor];
    msg += nome + ": " + (contagem[cor] || 0) + " porcas\n";
  }
  
  // Calcula o total de porcas
  let total = 0;
  for (let i = 0; i < qtdCores; i++) {
    total += contagem[CORES[i]] || 0;
  }
  
  msg += "\nTotal: " + total + " porcas";
  msg += "\nEsperado: " + (qtdCores * 4) + " porcas";
  
  alert(msg);
}

// =====================================================
// FUN√á√ïES DE COMEMORA√á√ÉO
// =====================================================

/**
 * Ativa a comemora√ß√£o visual quando um n√≠vel √© completado
 */
function comemorar() {
  let celebracao = document.getElementById("celebracao");
  let mensagem = document.getElementById("mensagem-parabens");
  
  // Limpa elementos anteriores
  celebracao.innerHTML = "";
  
  // Define a mensagem baseada no n√≠vel
  let texto = "";
  if (nivelAtual === 1) texto = "üéâ N√çVEL 1 COMPLETO! üéâ";
  else if (nivelAtual === 2) texto = "üéâ N√çVEL 2 COMPLETO! üéâ";
  else texto = "üèÜ N√çVEL 3 COMPLETO! üèÜ";
  
  mensagem.textContent = texto;
  
  // Cria 30 confetes
  for (let i = 0; i < 30; i++) {
    let confete = document.createElement("div");
    confete.className = "confete";
    
    // Cores aleat√≥rias
    let cores = ["#e74c3c", "#3498db", "#2ecc71", "#f1c40f", "#9b59b6", "#e67e22", "#1abc9c"];
    confete.style.background = cores[Math.floor(Math.random() * cores.length)];
    
    // Posi√ß√£o horizontal aleat√≥ria
    confete.style.left = Math.random() * 100 + "%";
    
    // Dura√ß√£o aleat√≥ria para efeito mais natural
    confete.style.animationDuration = (2 + Math.random() * 2) + "s";
    
    // Atraso aleat√≥rio
    confete.style.animationDelay = Math.random() * 0.5 + "s";
    
    celebracao.appendChild(confete);
  }
  
  // Cria estrelas brilhantes
  for (let i = 0; i < 20; i++) {
    let estrela = document.createElement("div");
    estrela.className = "estrela";
    estrela.style.left = Math.random() * 100 + "%";
    estrela.style.top = Math.random() * 100 + "%";
    estrela.style.animationDelay = Math.random() * 1 + "s";
    celebracao.appendChild(estrela);
  }
  
  // Mostra os elementos
  celebracao.style.display = "block";
  mensagem.style.display = "block";
  
  // Esconde ap√≥s 3 segundos
  setTimeout(function() {
    celebracao.style.display = "none";
    mensagem.style.display = "none";
  }, 3000);
}

// =====================================================
// FUN√á√ïES PRINCIPAIS DO JOGO
// =====================================================

/**
 * Gera um novo tabuleiro com distribui√ß√£o equilibrada das porcas
 * Garante que haja exatamente 4 porcas de cada cor do n√≠vel atual
 * Distribui as porcas entre os 18 parafusos
 */
function gerarTabuleiro() {
  let qtdCores = getQtdCores();
  
  // Cria um pool com 4 porcas de cada cor (garantido!)
  let pool = [];
  for (let i = 0; i < qtdCores; i++) {
    for (let j = 0; j < CAPACIDADE; j++) {
      pool.push(CORES[i]);
    }
  }
  
  // Embaralha o pool para distribui√ß√£o aleat√≥ria
  pool = embaralhar(pool);
  
  // Inicializa os 18 parafusos como arrays vazios
  parafusos = Array(18).fill().map(() => []);
  
  // Primeira passagem: cada parafuso recebe pelo menos 1 porca
  // Isso garante que nenhum parafuso comece vazio
  for (let i = 0; i < 18; i++) {
    if (pool.length > 0) {
      parafusos[i].push(pool.pop());
    }
  }
  
  // Segunda passagem: distribui o restante das porcas aleatoriamente
  // Cria um array com √≠ndices embaralhados para distribui√ß√£o uniforme
  let indices = [];
  for (let i = 0; i < 18; i++) {
    indices.push(i);
  }
  indices = embaralhar(indices);
  
  // Distribui as porcas restantes
  while (pool.length > 0) {
    for (let idx = 0; idx < indices.length; idx++) {
      if (pool.length === 0) break;
      if (parafusos[indices[idx]].length < CAPACIDADE) {
        parafusos[indices[idx]].push(pool.pop());
      }
    }
  }
  
  // Embaralha cada pilha individualmente para maior aleatoriedade
  for (let i = 0; i < 18; i++) {
    parafusos[i] = embaralhar(parafusos[i]);
  }
  
  // Reinicia flags
  processandoRodada = false;
  ultimaSequencia = [];
}

/**
 * Conta quantos parafusos est√£o completos no tabuleiro
 * Um parafuso est√° completo quando tem 4 porcas da mesma cor
 * @returns {number} N√∫mero de parafusos completos
 */
function contarCompletos() {
  let count = 0;
  for (let i = 0; i < 18; i++) {
    if (estaCompleto(i)) {
      count++;
    }
  }
  return count;
}

/**
 * Verifica a maior sequ√™ncia de parafusos completos consecutivos
 * Uma sequ√™ncia √© definida por parafusos completos em √≠ndices consecutivos
 * @returns {Object} Objeto com tamanho da maior sequ√™ncia e √≠ndices dos parafusos
 */
function verificarSequencia() {
  let maiorSequencia = 0;
  let sequenciaAtual = 0;
  let indicesSequencia = [];
  let indicesAtuais = [];
  
  // Percorre todos os parafusos em ordem
  for (let i = 0; i < 18; i++) {
    if (estaCompleto(i)) {
      sequenciaAtual++;
      indicesAtuais.push(i);
      if (sequenciaAtual > maiorSequencia) {
        maiorSequencia = sequenciaAtual;
        indicesSequencia = [];
        for (let j = 0; j < indicesAtuais.length; j++) {
          indicesSequencia.push(indicesAtuais[j]);
        }
      }
    } else {
      sequenciaAtual = 0;
      indicesAtuais = [];
    }
  }
  
  // Atualiza a vari√°vel global e o elemento HTML
  ultimaSequencia = indicesSequencia;
  document.getElementById("sequenciaTamanho").textContent = maiorSequencia;
  
  return {
    tamanho: maiorSequencia,
    indices: indicesSequencia
  };
}

// =====================================================
// L√ìGICA DE PONTUA√á√ÉO POR SEQU√äNCIA (PROPOSITAL)
// =====================================================
//
// Esta l√≥gica foi projetada para ser GENEROSA e MOTIVADORA,
// n√£o para ser matematicamente precisa.
//
// üéØ OBJETIVO PEDAG√ìGICO:
//    Incentivar os alunos a buscarem sequ√™ncias de parafusos
//    completos, tornando o jogo mais prazeroso e recompensador.
//
// üìä COMO FUNCIONA (ACUMULATIVO):
//    Sempre que a MAIOR SEQU√äNCIA de parafusos completos AUMENTA,
//    o jogador ganha um b√¥nus baseado NOVO tamanho:
//    
//    Sequ√™ncia 3 ‚Üí +50 pontos
//    Sequ√™ncia 4 ‚Üí +100 pontos (total acumulado 150)
//    Sequ√™ncia 5 ‚Üí +200 pontos (total acumulado 350)
//    Sequ√™ncia 6 ‚Üí +200 pontos (total acumulado 550)
//    ...
//
// üß† POR QUE ASSIM?
//    - Cada novo parafuso na sequ√™ncia parece "valer mais"
//    - A pontua√ß√£o sobe de forma vis√≠vel e emocionante
//    - Os alunos sentem que vale a pena tentar fazer sequ√™ncias
//    - O engajamento aumenta significativamente
//
// ‚ö†Ô∏è DIFEREN√áA DO MODELO "MATEMATICAMENTE CORRETO":
//    No modelo tradicional, o b√¥nus seria aplicado apenas UMA VEZ
//    por sequ√™ncia (ex: sequ√™ncia 5 = 200 pontos, independente de
//    quanto tempo levou para chegar l√°). Isso √© menos motivador.
//
// ‚úÖ CONCLUS√ÉO:
//    Esta l√≥gica √© INTENCIONAL e est√° alinhada com o objetivo
//    pedag√≥gico do jogo: aprender brincando, com recompensas
//    generosas que mant√™m o interesse dos alunos.
//
// =====================================================

/**
 * Calcula o b√¥nus baseado no tamanho da sequ√™ncia
 * @param {number} tamanho - Tamanho da sequ√™ncia
 * @returns {number} B√¥nus em pontos
 */
function calcularBonusSequencia(tamanho) {
  if (tamanho >= 5) return 200;
  if (tamanho === 4) return 100;
  if (tamanho === 3) return 50;
  return 0;
}

/**
 * Retorna quantas porcas iguais est√£o no topo de um parafuso
 * Usado para movimento em bloco
 * @param {number} idx - √çndice do parafuso
 * @returns {number} Quantidade de porcas iguais no topo
 */
function getBlocoTopo(idx) {
  if (idx === null) return 0;
  if (parafusos[idx].length === 0) return 0;
  
  let cor = parafusos[idx][parafusos[idx].length - 1];
  let count = 0;
  
  // Conta quantas porcas iguais h√° a partir do topo
  for (let i = parafusos[idx].length - 1; i >= 0; i--) {
    if (parafusos[idx][i] === cor) {
      count++;
    } else {
      break;
    }
  }
  
  return count;
}

/**
 * Ajusta o brilho de uma cor (para dar efeito 3D nas porcas)
 * @param {string} hex - Cor em formato hexadecimal (#RRGGBB)
 * @param {number} percent - Percentual de ajuste (-20 escurece, +20 clareia)
 * @returns {string} Cor ajustada em formato hexadecimal
 */
function ajustarCor(hex, percent) {
  let r = parseInt(hex.substring(1, 3), 16);
  let g = parseInt(hex.substring(3, 5), 16);
  let b = parseInt(hex.substring(5, 7), 16);
  
  r = Math.max(0, Math.min(255, r + percent));
  g = Math.max(0, Math.min(255, g + percent));
  b = Math.max(0, Math.min(255, b + percent));
  
  return "#" + r.toString(16).padStart(2, '0') + g.toString(16).padStart(2, '0') + b.toString(16).padStart(2, '0');
}

/**
 * Desenha o tabuleiro na tela
 * Reconstr√≥i todos os elementos HTML dos parafusos e porcas
 */
function desenhar() {
  let board = document.getElementById("board");
  board.innerHTML = "";
  
  // Atualiza informa√ß√µes da topbar
  document.getElementById("moves").textContent = movimentos;
  document.getElementById("score").textContent = pontos;
  
  let completos = contarCompletos();
  let meta = getMetaRodada();
  
  document.getElementById("completosRodada").textContent = completos;
  document.getElementById("metaRodada").textContent = meta;
  
  // Calcula e atualiza a barra de progresso
  let progresso = (completos / meta) * 100;
  if (progresso > 100) progresso = 100;
  document.getElementById("progress-fill").style.width = progresso + "%";
  
  document.getElementById("nivelAtual").textContent = "N√≠vel " + nivelAtual;
  document.getElementById("desafioAtual").textContent = "Rodada " + rodadaAtual + "/" + getTotalRodadas();
  
  // Verifica a sequ√™ncia atual
  let seq = verificarSequencia();
  
  // Itera sobre todos os parafusos
  for (let idx = 0; idx < 18; idx++) {
    let parafuso = parafusos[idx];
    
    let div = document.createElement("div");
    div.className = "screw";
    
    // Adiciona classe se estiver selecionado
    if (selecionado === idx) {
      div.classList.add("selected");
    }
    
    // Adiciona classe se estiver completo
    if (estaCompleto(idx)) {
      div.classList.add("locked");
    }
    
    // Adiciona classe se fizer parte da sequ√™ncia
    if (seq.indices.includes(idx)) {
      div.classList.add("sequencia");
    }
    
    // Adiciona evento de clique (usando closure para capturar o √≠ndice)
    div.onclick = (function(index) {
      return function() {
        cliqueParafuso(index);
      };
    })(idx);
    
    // Adiciona as porcas (do fundo para o topo)
    for (let i = 0; i < parafuso.length; i++) {
      let nut = document.createElement("div");
      nut.className = "nut";
      // Aplica gradiente para efeito 3D
      nut.style.background = "linear-gradient(145deg, " + parafuso[i] + ", " + ajustarCor(parafuso[i], -20) + ")";
      nut.title = NOMES_CORES[parafuso[i]]; // Tooltip com o nome da cor
      div.appendChild(nut);
    }
    
    // Adiciona placeholders invis√≠veis para manter o tamanho do parafuso
    for (let i = parafuso.length; i < CAPACIDADE; i++) {
      let placeholder = document.createElement("div");
      placeholder.className = "nut-placeholder";
      div.appendChild(placeholder);
    }
    
    board.appendChild(div);
  }
}

/**
 * Verifica se um parafuso est√° completo
 * @param {number} idx - √çndice do parafuso
 * @returns {boolean} True se o parafuso tem 4 porcas da mesma cor
 */
function estaCompleto(idx) {
  let p = parafusos[idx];
  if (p.length !== CAPACIDADE) return false;
  
  let primeiraCor = p[0];
  for (let i = 1; i < p.length; i++) {
    if (p[i] !== primeiraCor) return false;
  }
  
  return true;
}

/**
 * Processa clique em um parafuso
 * Se n√£o h√° parafuso selecionado, seleciona o clicado
 * Se h√° parafuso selecionado, tenta mover a(s) porca(s)
 * @param {number} idx - √çndice do parafuso clicado
 */
function cliqueParafuso(idx) {
  // Se estiver processando uma rodada, ignora cliques
  if (processandoRodada) return;
  
  // Se o parafuso estiver completo, n√£o pode selecionar
  if (estaCompleto(idx)) {
    feedback("‚ùå Parafuso j√° est√° completo! N√£o pode mover.");
    return;
  }
  
  // Se n√£o h√° parafuso selecionado
  if (selecionado === null) {
    // S√≥ pode selecionar se tiver porcas
    if (parafusos[idx].length > 0) {
      selecionado = idx;
      desenhar();
    }
  } else {
    // Move de selecionado para idx
    mover(selecionado, idx);
    selecionado = null;
    desenhar();
  }
}

/**
 * Move porcas de um parafuso de origem para um destino
 * Implementa movimento em bloco (move todas as porcas iguais do topo)
 * @param {number} origem - √çndice do parafuso de origem
 * @param {number} destino - √çndice do parafuso de destino
 */
function mover(origem, destino) {
  // N√£o pode mover para o mesmo parafuso
  if (origem === destino) return;
  
  // Origem n√£o pode estar vazia
  if (parafusos[origem].length === 0) return;
  
  // Verifica tamanho do bloco (quantas porcas iguais no topo)
  let bloco = getBlocoTopo(origem);
  let espaco = CAPACIDADE - parafusos[destino].length;
  
  // Verifica se h√° espa√ßo suficiente no destino
  if (espaco < bloco) {
    feedback("‚ùå Espa√ßo insuficiente! Cabe apenas " + espaco);
    return;
  }
  
  // Verifica se a cor do topo da origem √© compat√≠vel com o destino
  let corOrigem = parafusos[origem][parafusos[origem].length - 1];
  let topoDestino = null;
  if (parafusos[destino].length > 0) {
    topoDestino = parafusos[destino][parafusos[destino].length - 1];
  }
  
  // S√≥ pode mover se destino estiver vazio ou tiver a mesma cor
  if (topoDestino === null || topoDestino === corOrigem) {
    // Salva estado atual no hist√≥rico para permitir desfazer
    let estadoParaHistorico = {
      parafusos: [],
      movimentos: movimentos,
      pontos: pontos,
      rodadaAtual: rodadaAtual
    };
    
    // Faz c√≥pia profunda dos parafusos
    for (let i = 0; i < 18; i++) {
      estadoParaHistorico.parafusos.push([]);
      for (let j = 0; j < parafusos[i].length; j++) {
        estadoParaHistorico.parafusos[i].push(parafusos[i][j]);
      }
    }
    
    historico.push(JSON.stringify(estadoParaHistorico));
    
    // Move o bloco inteiro (da origem para o destino)
    for (let i = 0; i < bloco; i++) {
      let porca = parafusos[origem].pop();
      parafusos[destino].push(porca);
    }
    
    movimentos++;
    
    // Verifica se o destino foi completado com este movimento
    if (estaCompleto(destino)) {
      pontos += 20;
      
      // Verifica se formou uma sequ√™ncia
      let seq = verificarSequencia();
      let bonus = calcularBonusSequencia(seq.tamanho);
      
      if (bonus > 0) {
        pontos += bonus;
        feedback("üèÜ SEQU√äNCIA DE " + seq.tamanho + "! +" + bonus + " pontos", 3000);
      } else {
        feedback("‚úÖ Parafuso " + (destino + 1) + " completo! +20 pontos");
      }
    } else {
      // Se moveu mais de uma porca, informa
      if (bloco > 1) {
        feedback("üì¶ Movidas " + bloco + " porcas de uma vez!", 1500);
      }
    }
    
    desenhar();
    
    // Verifica se a rodada foi completada
    let completos = contarCompletos();
    let meta = getMetaRodada();
    
    if (completos >= meta && !processandoRodada) {
      processandoRodada = true;
      
      // B√¥nus por completar a rodada
      pontos += 50;
      feedback("üéØ RODADA " + rodadaAtual + " COMPLETA! +50 pontos", 3000);
      
      rodadaAtual++;
      
      // Verifica se completou todas as rodadas do n√≠vel
      if (rodadaAtual > getTotalRodadas()) {
        CONFIG[nivelAtual].completa = true;
        let bonus = getBonus();
        pontos += bonus;
        
        // =====================================================
        // ATIVA COMEMORA√á√ÉO
        // =====================================================
        comemorar();
        
        // Avan√ßa para o pr√≥ximo n√≠vel ap√≥s 3 segundos (tempo da comemora√ß√£o)
        setTimeout(function() {
          if (nivelAtual < 3) {
            nivelAtual++;
            rodadaAtual = 1;
            movimentos = 0;
            historico = [];
            selecionado = null;
            gerarTabuleiro();
            desenhar();
            feedback("üéâ N√çVEL " + nivelAtual + "! Rodada 1/" + getTotalRodadas());
          } else {
            feedback("üéâ PARAB√âNS! VOC√ä VENCEU TODAS AS RODADAS!", 5000);
          }
        }, 3000);
      } else {
        // Pr√≥xima rodada do mesmo n√≠vel ap√≥s 1.5 segundos
        setTimeout(function() {
          gerarTabuleiro();
          desenhar();
          feedback("üîÑ Rodada " + rodadaAtual + "/" + getTotalRodadas());
        }, 1500);
      }
    }
  } else {
    // Cores diferentes
    feedback("‚ùå Cores diferentes!");
    selecionado = null;
  }
}

/**
 * Desfaz o √∫ltimo movimento
 * Restaura o estado anterior a partir do hist√≥rico
 */
function desfazer() {
  if (processandoRodada) {
    feedback("‚è≥ Aguarde a transi√ß√£o da rodada...");
    return;
  }
  
  if (historico.length === 0) {
    feedback("Nada para desfazer");
    return;
  }
  
  // Recupera o √∫ltimo estado do hist√≥rico
  let estado = JSON.parse(historico.pop());
  
  // Restaura os parafusos
  parafusos = [];
  for (let i = 0; i < estado.parafusos.length; i++) {
    parafusos.push([]);
    for (let j = 0; j < estado.parafusos[i].length; j++) {
      parafusos[i].push(estado.parafusos[i][j]);
    }
  }
  
  movimentos = estado.movimentos;
  pontos = estado.pontos;
  rodadaAtual = estado.rodadaAtual;
  
  selecionado = null;
  desenhar();
  
  feedback("‚Ü©Ô∏è Movimento desfeito");
}

/**
 * Verifica a senha digitada no painel do professor
 * Se correta, desbloqueia o n√≠vel solicitado
 * @param {number} nivel - N√≠vel a ser desbloqueado (1, 2 ou 3)
 */
function verificarSenha(nivel) {
  let senha = document.getElementById("senhaInput").value;
  
  if (senha === SENHA_PROFESSOR) {
    nivelAtual = nivel;
    rodadaAtual = 1;
    movimentos = 0;
    historico = [];
    selecionado = null;
    processandoRodada = false;
    
    gerarTabuleiro();
    desenhar();
    
    feedback("üë®‚Äçüè´ N√≠vel " + nivel + " desbloqueado!");
    fecharPainelProfessor();
  } else {
    feedback("‚ùå Senha incorreta!");
    document.getElementById("senhaInput").value = "";
  }
}

/**
 * Exibe uma mensagem flutuante na tela
 * @param {string} msg - Mensagem a ser exibida
 * @param {number} tempo - Dura√ß√£o em milissegundos (padr√£o: 2000)
 */
function feedback(msg, tempo) {
  if (tempo === undefined) tempo = 2000;
  
  // Remove mensagem anterior se existir
  let fb = document.querySelector(".feedback");
  if (fb) fb.remove();
  
  // Cria nova mensagem
  fb = document.createElement("div");
  fb.className = "feedback";
  fb.textContent = msg;
  
  document.body.appendChild(fb);
  
  // Remove ap√≥s o tempo especificado
  setTimeout(function() {
    fb.remove();
  }, tempo);
}

// =====================================================
// FUN√á√ïES DOS MODAIS
// =====================================================

/**
 * Abre o modal de instru√ß√µes
 */
function mostrarInstrucoes() {
  document.getElementById("instructions").style.display = "flex";
}

/**
 * Fecha o modal de instru√ß√µes
 */
function fecharInstrucoes() {
  document.getElementById("instructions").style.display = "none";
}

/**
 * Abre o modal da BNCC
 */
function mostrarBNCC() {
  document.getElementById("bnccModal").style.display = "flex";
}

/**
 * Fecha o modal da BNCC
 */
function fecharBNCC() {
  document.getElementById("bnccModal").style.display = "none";
}

/**
 * Abre o painel do professor
 */
function mostrarPainelProfessor() {
  document.getElementById("teacherPanel").style.display = "flex";
  document.getElementById("senhaInput").value = "";
}

/**
 * Fecha o painel do professor
 */
function fecharPainelProfessor() {
  document.getElementById("teacherPanel").style.display = "none";
}

/**
 * Reinicia o jogo do zero (n√≠vel 1, rodada 1)
 * Pergunta confirma√ß√£o se houver progresso
 */
function novoJogo() {
  if (pontos > 0 || movimentos > 0) {
    if (!confirm("Tem certeza? Todo progresso atual ser√° perdido!")) {
      return;
    }
  }
  
  nivelAtual = 1;
  rodadaAtual = 1;
  
  CONFIG[1].completa = false;
  CONFIG[2].completa = false;
  CONFIG[3].completa = false;
  
  movimentos = 0;
  pontos = 0;
  historico = [];
  selecionado = null;
  processandoRodada = false;
  
  gerarTabuleiro();
  desenhar();
  
  feedback("üåü N√≠vel 1 - Rodada 1/" + getTotalRodadas());
}

// =====================================================
// PROTE√á√ÉO CONTRA FECHAMENTO ACIDENTAL
// =====================================================

/**
 * Bloqueia teclas de atalho que poderiam fechar ou recarregar o app
 */
document.addEventListener('keydown', function(event) {
  // Lista de teclas proibidas
  const teclasProibidas = ['F5', 'F4', 'F3', 'F2', 'F1'];
  
  // Previne F5, F4, F3, F2, F1
  if (teclasProibidas.includes(event.key)) {
    event.preventDefault();
    feedback("‚ö†Ô∏è Use os bot√µes do jogo para navegar", 1500);
    return false;
  }
  
  // Previne Ctrl+R (recarregar)
  if (event.ctrlKey && (event.key === 'r' || event.key === 'R')) {
    event.preventDefault();
    feedback("‚ö†Ô∏è Use os bot√µes do jogo para navegar", 1500);
    return false;
  }
  
  // Previne Ctrl+W (fechar aba)
  if (event.ctrlKey && (event.key === 'w' || event.key === 'W')) {
    event.preventDefault();
    feedback("‚ö†Ô∏è Para sair, use o bot√£o do navegador", 1500);
    return false;
  }
  
  // Previne Ctrl+N (nova janela)
  if (event.ctrlKey && (event.key === 'n' || event.key === 'N')) {
    event.preventDefault();
    feedback("‚ö†Ô∏è Use os bot√µes do jogo para navegar", 1500);
    return false;
  }
  
  // Previne Ctrl+T (nova aba)
  if (event.ctrlKey && (event.key === 't' || event.key === 'T')) {
    event.preventDefault();
    feedback("‚ö†Ô∏è Use os bot√µes do jogo para navegar", 1500);
    return false;
  }
  
  // Previne Alt+F4 (fechar janela) - funciona apenas em alguns navegadores
  if (event.altKey && event.key === 'F4') {
    event.preventDefault();
    feedback("‚ö†Ô∏è Para sair, use o bot√£o do navegador", 1500);
    return false;
  }
  
  // Previne Alt+‚Üê (voltar) e Alt+‚Üí (avan√ßar)
  if (event.altKey && (event.key === 'ArrowLeft' || event.key === 'ArrowRight')) {
    event.preventDefault();
    feedback("‚ö†Ô∏è Use os bot√µes do jogo para navegar", 1500);
    return false;
  }
});

/**
 * Previne clique com bot√£o direito (menu contextual)
 */
document.addEventListener('contextmenu', function(event) {
  event.preventDefault();
  feedback("‚ö†Ô∏è Menu desabilitado", 1000);
  return false;
});

/**
 * Previne duplo clique que poderia selecionar texto
 * Permite duplo clique apenas em elementos interativos
 */
document.addEventListener('dblclick', function(event) {
  if (!event.target.closest('.screw') && !event.target.closest('button')) {
    event.preventDefault();
    return false;
  }
});

/**
 * Previne arraste de elementos
 */
document.addEventListener('dragstart', function(event) {
  event.preventDefault();
  return false;
});

/**
 * Previne sele√ß√£o de texto (refor√ßo)
 */
document.addEventListener('selectstart', function(event) {
  event.preventDefault();
  return false;
});

// =====================================================
// AVISO AO FECHAR A P√ÅGINA (MANTIDO)
// =====================================================

/**
 * Evento disparado quando o usu√°rio tenta fechar ou recarregar a p√°gina
 * Exibe um aviso se houver progresso para evitar perda acidental
 */
window.addEventListener('beforeunload', function(event) {
  if (pontos > 0 || movimentos > 0) {
    event.preventDefault();
    event.returnValue = '';
    return '';
  }
});

// =====================================================
// INICIALIZA√á√ÉO DO JOGO
// =====================================================

// Inicia o jogo
novoJogo();

// Exporta fun√ß√µes para o escopo global (para serem chamadas pelos bot√µes HTML)
window.novoJogo = novoJogo;
window.desfazer = desfazer;
window.mostrarInstrucoes = mostrarInstrucoes;
window.fecharInstrucoes = fecharInstrucoes;
window.mostrarBNCC = mostrarBNCC;
window.fecharBNCC = fecharBNCC;
window.mostrarPainelProfessor = mostrarPainelProfessor;
window.fecharPainelProfessor = fecharPainelProfessor;
window.verificarSenha = verificarSenha;
window.diagnosticar = diagnosticar;
window.gerarCodigo = gerarCodigo;
window.restaurarCodigo = restaurarCodigo;
</script>
</body>
</html>
