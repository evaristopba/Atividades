<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Parafusos e Porcas - FINAL</title>
<style>
* {
  box-sizing: border-box;
  user-select: none;
}

html, body {
  height: 100%;
  margin: 0;
  padding: 10px;
  overflow: hidden;
}

body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
  text-align: center;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

h1 {
  color: white;
  margin: 5px 0 10px;
  font-size: 2rem;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
  flex-shrink: 0;
}

#topbar {
  background: rgba(255, 255, 255, 0.95);
  padding: 8px 12px;
  border-radius: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 10px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(10px);
  border: 2px solid #f1c40f;
  flex-shrink: 0;
  min-height: 48px;
}

.info-item, .nivel-badge, .desafio-info, #sequencia-info {
  background: #ecf0f1;
  padding: 4px 10px;
  border-radius: 30px;
  font-weight: 700;
  color: #2c3e50;
  box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
  font-size: 0.85rem;
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  gap: 3px;
  line-height: 1.2;
  position: relative;
}

/* Tooltips */
.info-item[title]:hover::after, 
.nivel-badge[title]:hover::after, 
.desafio-info[title]:hover::after, 
#sequencia-info[title]:hover::after,
button[title]:hover::after {
  content: attr(title);
  position: absolute;
  bottom: 125%;
  left: 50%;
  transform: translateX(-50%);
  background: #2c3e50;
  color: white;
  padding: 4px 8px;
  border-radius: 15px;
  font-size: 0.7rem;
  white-space: nowrap;
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  border: 1px solid #f1c40f;
  z-index: 1000;
  pointer-events: none;
}

button, select {
  padding: 4px 10px;
  border-radius: 30px;
  border: none;
  background: #3498db;
  font-weight: 700;
  cursor: pointer;
  color: white;
  font-size: 0.85rem;
  box-shadow: 0 2px 0 #2980b9, 0 3px 6px rgba(0, 0, 0, 0.2);
  transition: all 0.1s;
  white-space: nowrap;
  line-height: 1.2;
  position: relative;
}

button:hover, select:hover {
  background: #2980b9;
  transform: translateY(-1px);
  box-shadow: 0 3px 0 #1f618d, 0 4px 8px rgba(0, 0, 0, 0.2);
}

button:active {
  transform: translateY(2px);
  box-shadow: 0 1px 0 #1f618d;
}

#board {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 8px;
  max-width: 1000px;
  margin: 0 auto;
  width: 100%;
  flex: 1;
  min-height: 0;
  overflow: hidden;
}

.screw {
  background: linear-gradient(145deg, #bdc3c7, #95a5a6);
  border-radius: 18px 18px 6px 6px;
  padding: 4px 2px 6px;
  height: 100%;
  max-height: 180px;
  display: flex;
  flex-direction: column-reverse;
  align-items: center;
  justify-content: flex-start;
  border: 3px solid #7f8c8d;
  box-shadow: 0 4px 0 #4a5a5a, 0 6px 10px rgba(0, 0, 0, 0.4);
  position: relative;
  cursor: pointer;
  transition: all 0.1s;
  background-image: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.3) 0%, transparent 30%);
}

.screw::after {
  content: "";
  position: absolute;
  bottom: -2px;
  left: 50%;
  transform: translateX(-50%);
  width: 30px;
  height: 10px;
  background: linear-gradient(90deg, #7f8c8d, #4a5a5a, #7f8c8d);
  border-radius: 4px 4px 0 0;
  border: 2px solid #2c3e50;
  border-bottom: none;
  box-shadow: inset 0 2px 2px rgba(0, 0, 0, 0.3);
}

.screw.selected {
  border: 4px solid #f1c40f;
  box-shadow: 0 0 0 3px #f7dc6f, 0 4px 0 #b7950b;
}

.screw.sequencia {
  border: 3px solid #f39c12;
  box-shadow: 0 0 8px #f39c12, 0 4px 0 #b7950b;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0% { border-color: #f39c12; }
  50% { border-color: #f1c40f; }
  100% { border-color: #f39c12; }
}

.nut {
  width: 32px;
  height: 32px;
  margin: 1px 0;
  border: 2px solid #2c3e50;
  box-shadow: 0 2px 0 #1a2632, 0 3px 5px rgba(0, 0, 0, 0.3);
  transition: 0.05s;
  flex-shrink: 0;
  background: linear-gradient(145deg, #ecf0f1, #bdc3c7);
  clip-path: polygon(25% 0%, 75% 0%, 100% 25%, 100% 75%, 75% 100%, 25% 100%, 0% 75%, 0% 25%);
  position: relative;
}

.nut::after {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 12px;
  height: 12px;
  background: linear-gradient(145deg, #7f8c8d, #4a5a5a);
  border-radius: 50%;
  border: 2px solid #2c3e50;
}

.nut::before {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 4px;
  height: 4px;
  background: #f1c40f;
  border-radius: 50%;
  z-index: 2;
  border: 1px solid #b7950b;
}

.nut-placeholder {
  width: 32px;
  height: 32px;
  margin: 1px 0;
  visibility: hidden;
  flex-shrink: 0;
}

.locked {
  border: 3px solid #27ae60 !important;
  background: linear-gradient(145deg, #d5f5e3, #a9dfbf) !important;
  box-shadow: 0 4px 0 #1e8449, 0 6px 10px rgba(0, 0, 0, 0.3) !important;
}

.locked::after {
  content: "âœ“";
  position: absolute;
  top: -4px;
  right: -4px;
  background: #27ae60;
  color: white;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 11px;
  border: 2px solid #f1c40f;
  z-index: 10;
}

#progress-bar {
  width: 100px;
  height: 8px;
  background: #ecf0f1;
  border-radius: 20px;
  overflow: hidden;
  border: 1px solid #2980b9;
  flex-shrink: 0;
}

#progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #27ae60, #2ecc71);
  width: 0%;
  transition: width 0.3s;
}

.feedback {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #2c3e50;
  color: white;
  padding: 8px 20px;
  border-radius: 30px;
  font-size: 0.9rem;
  font-weight: bold;
  box-shadow: 0 5px 15px black;
  z-index: 1000;
  border: 2px solid #f1c40f;
}

#instructions, #teacherPanel, #bnccModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(5px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.modal-content {
  background: white;
  padding: 20px;
  border-radius: 25px;
  max-width: 450px;
  max-height: 80vh;
  overflow-y: auto;
  border: 4px solid #f1c40f;
  text-align: left;
}

.close-btn {
  float: right;
  background: #e74c3c;
  color: white;
  border: none;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  font-size: 15px;
  cursor: pointer;
  border: 2px solid #c0392b;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-btn:hover {
  background: #c0392b;
}

.teacher-input {
  padding: 5px;
  font-size: 0.9rem;
  border-radius: 30px;
  border: 2px solid #2c3e50;
  width: 150px;
  text-align: center;
  margin-bottom: 8px;
}

.diagnostico-btn {
  background: #e67e22;
  margin-top: 10px;
  width: 100%;
  font-size: 0.85rem;
  padding: 6px;
}

.diagnostico-btn:hover {
  background: #d35400;
}

.bncc-section {
  background: #ecf0f1;
  border-radius: 12px;
  padding: 10px;
  margin: 10px 0;
  border-left: 5px solid #27ae60;
}

.bncc-section h3 {
  color: #27ae60;
  margin-top: 0;
  font-size: 1rem;
}

.bncc-code {
  background: #2c3e50;
  color: white;
  padding: 2px 6px;
  border-radius: 20px;
  display: inline-block;
  font-weight: bold;
  margin: 2px 0;
  font-size: 0.8rem;
}
</style>
</head>
<body>

<h1>ğŸ”§ PARAFUSOS E PORCAS ğŸ”©</h1>

<div id="topbar">
  <div class="info-item" title="PontuaÃ§Ã£o total">â­ <span id="score">0</span></div>
  <div class="info-item" title="Movimentos realizados">ğŸ”„ <span id="moves">0</span></div>
  <div class="info-item" title="Parafusos completos na rodada">ğŸ”’ <span id="completosRodada">0</span>/<span id="metaRodada">6</span></div>
  <div class="nivel-badge" id="nivelAtual" title="NÃ­vel atual">NÃ­vel 1</div>
  <div class="desafio-info" id="desafioAtual" title="Rodada atual">Rodada 1/10</div>
  <div id="sequencia-info" title="Maior sequÃªncia">ğŸ† <span id="sequenciaTamanho">0</span></div>
  <div id="progress-bar"><div id="progress-fill"></div></div>
  <button onclick="gerarCodigo()" title="Gerar cÃ³digo para continuar depois">ğŸ“‹ Gerar CÃ³digo</button>
  <button onclick="restaurarCodigo()" title="Restaurar progresso com cÃ³digo">ğŸ”„ Restaurar</button>
  <button onclick="desfazer()" title="Desfazer Ãºltimo movimento">â†©ï¸ Desfazer</button>
  <button onclick="mostrarInstrucoes()" title="Ver instruÃ§Ãµes">ğŸ“˜ Ajuda</button>
  <button onclick="mostrarPainelProfessor()" title="Painel do professor">ğŸ‘¨â€ğŸ« Professor</button>
</div>

<div id="board"></div>

<!-- Modal de InstruÃ§Ãµes -->
<div id="instructions">
  <div class="modal-content">
    <button class="close-btn" onclick="fecharInstrucoes()" title="Fechar">âœ•</button>
    <h2 style="margin-top:0; color:#2c3e50;">ğŸ“˜ COMO JOGAR</h2>
    
    <h3>ğŸ¯ Objetivo</h3>
    <p>Formar pilhas de <strong>4 porcas da mesma cor</strong> em cada parafuso.</p>
    
    <h3>ğŸ® Regras</h3>
    <ul>
      <li>Clique em um parafuso para pegar a porca do <strong>TOPO</strong></li>
      <li>Clique em outro parafuso para colocar</li>
      <li>SÃ³ pode colocar em parafuso <strong>vazio</strong> ou da <strong>mesma cor</strong></li>
      <li>MÃ¡ximo <strong>4 porcas</strong> por parafuso</li>
      <li><strong>ğŸš« Parafusos completos nÃ£o podem ser movidos!</strong></li>
    </ul>
    
    <h3>ğŸ“‹ CÃ“DIGO DE RESTAURAÃ‡ÃƒO</h3>
    <ul>
      <li><strong>ğŸ“Œ No final da aula</strong>, clique em "Gerar CÃ³digo"</li>
      <li><strong>âœï¸ Anote o nÃºmero no caderno</strong> (sÃ³ nÃºmeros!)</li>
      <li><strong>ğŸ”„ Na prÃ³xima aula</strong>, clique em "Restaurar" e digite o nÃºmero</li>
      <li>âœ… Seu jogo volta exatamente de onde parou!</li>
    </ul>
    
    <h3>ğŸ† BÃ´nus de SequÃªncia</h3>
    <ul>
      <li>+50 (3 parafusos seguidos), +100 (4), +200 (5+)</li>
    </ul>
    
    <h3>ğŸ“Š ProgressÃ£o</h3>
    <ul>
      <li><strong>NÃ­vel 1:</strong> 6 cores | 10 rodadas | meta: 6 parafusos</li>
      <li><strong>NÃ­vel 2:</strong> 9 cores | 20 rodadas | meta: 9 parafusos</li>
      <li><strong>NÃ­vel 3:</strong> 12 cores | 35 rodadas | meta: 12 parafusos</li>
    </ul>
  </div>
</div>

<!-- Modal BNCC -->
<div id="bnccModal">
  <div class="modal-content">
    <button class="close-btn" onclick="fecharBNCC()" title="Fechar">âœ•</button>
    <h2 style="margin-top:0; color:#2c3e50;">ğŸ“š BNCC</h2>
    <div class="bncc-section">
      <h3>ğŸŒ± EDUCAÃ‡ÃƒO INFANTIL</h3>
      <span class="bncc-code">EI03ET01</span> Comparar objetos<br>
      <span class="bncc-code">EI03ET05</span> Classificar propriedades
    </div>
    <div class="bncc-section">
      <h3>ğŸ“ ENSINO FUNDAMENTAL</h3>
      <span class="bncc-code">EF01MA09</span> Ordenar objetos<br>
      <span class="bncc-code">EF02MA18</span> DireÃ§Ã£o e sentido<br>
      <span class="bncc-code">EF03MA25</span> SequÃªncias
    </div>
    <p style="font-style: italic; color: #27ae60; text-align: center;">"Aprender brincando fixa o conhecimento!"</p>
  </div>
</div>

<!-- Modal do Professor -->
<div id="teacherPanel">
  <div class="modal-content">
    <button class="close-btn" onclick="fecharPainelProfessor()" title="Fechar">âœ•</button>
    <h2 style="margin-top:0; color:#2c3e50;">ğŸ‘¨â€ğŸ« PAINEL DO PROFESSOR</h2>
    
    <p>ğŸ”“ <strong>Desbloquear nÃ­veis:</strong></p>
    <input type="password" id="senhaInput" class="teacher-input" placeholder="Senha" maxlength="5">
    <div style="margin: 10px 0; text-align: center;">
      <button onclick="verificarSenha(1)" style="margin:2px;">NÃ­vel 1</button>
      <button onclick="verificarSenha(2)" style="margin:2px;">NÃ­vel 2</button>
      <button onclick="verificarSenha(3)" style="margin:2px;">NÃ­vel 3</button>
    </div>
    
    <hr>
    <p>ğŸ” <strong>DiagnÃ³stico:</strong></p>
    <button onclick="diagnosticar()" class="diagnostico-btn">ğŸ“Š Contar cores</button>
    <p style="font-size:0.8rem; color:#7f8c8d;">Mostra quantas porcas de cada cor</p>
  </div>
</div>

<script>
// =====================================================
// CORES E CONFIGURAÃ‡Ã•ES
// =====================================================
const CORES = [
  "#ef4444", "#3b82f6", "#22c55e", "#f59e0b", "#a855f7",
  "#ec4899", "#14b8a6", "#f97316", "#8b5cf6", "#06b6d4",
  "#d946ef", "#84cc16", "#f43f5e", "#10b981", "#6366f1"
];

const NOMES_CORES = {
  "#ef4444": "Vermelho", "#3b82f6": "Azul", "#22c55e": "Verde",
  "#f59e0b": "Laranja", "#a855f7": "Roxo", "#ec4899": "Rosa",
  "#14b8a6": "Turquesa", "#f97316": "Laranja escuro", "#8b5cf6": "Violeta",
  "#06b6d4": "Ciano", "#d946ef": "Magenta", "#84cc16": "Lima",
  "#f43f5e": "RosÃª", "#10b981": "Esmeralda", "#6366f1": "Ãndigo"
};

const CAPACIDADE = 4;
const SENHA_PROFESSOR = "P2026";

const CONFIG = {
  1: { cores: 6, totalRodadas: 10, bonus: 100, completa: false },
  2: { cores: 9, totalRodadas: 20, bonus: 200, completa: false },
  3: { cores: 12, totalRodadas: 35, bonus: 400, completa: false }
};

// =====================================================
// ESTADO DO JOGO
// =====================================================
let nivelAtual = 1;
let rodadaAtual = 1;
let parafusos = [];
let historico = [];
let movimentos = 0;
let pontos = 0;
let selecionado = null;
let processandoRodada = false;
let ultimaSequencia = [];

// =====================================================
// FUNÃ‡Ã•ES DO CÃ“DIGO (SALVAMENTO NO CADERNO)
// =====================================================
function gerarCodigo() {
  // Formato: NNN RR MMM PPPP
  let nivelStr = nivelAtual.toString().padStart(3, '0');
  let rodadaStr = rodadaAtual.toString().padStart(2, '0');
  let movStr = movimentos.toString().padStart(3, '0');
  let pontosStr = pontos.toString().padStart(4, '0');
  
  let codigo = nivelStr + rodadaStr + movStr + pontosStr;
  let codigoFormatado = `${nivelStr} ${rodadaStr} ${movStr} ${pontosStr}`;
  
  let mensagem = `
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   CÃ“DIGO DE RESTAURAÃ‡ÃƒO       â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                 â•‘
â•‘     ğŸ“ ${codigoFormatado}     â•‘
â•‘                                 â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ NÃ­vel: ${nivelAtual}  Rodada: ${rodadaAtual}/${getTotalRodadas()}
â•‘ Pontos: ${pontos}  Movimentos: ${movimentos}
â•‘ Parafusos: ${contarCompletos()}/18
â•‘                                 â•‘
â•‘ ANOTE NO CADERNO!               â•‘
â•‘ Na prÃ³xima aula, clique em      â•‘
â•‘ "Restaurar" e digite os 12      â•‘
â•‘ nÃºmeros em sequÃªncia.           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  `;
  
  alert(mensagem);
  
  // Tenta copiar automÃ¡tico
  try {
    navigator.clipboard.writeText(codigo);
    alert("ğŸ“‹ CÃ³digo copiado! (cole no celular/computador)");
  } catch (e) {}
}

function restaurarCodigo() {
  let codigo = prompt("Digite o cÃ³digo de 12 nÃºmeros:");
  if (!codigo) return;
  
  // Remove espaÃ§os, traÃ§os, pontos
  codigo = codigo.replace(/[-\s.]/g, '');
  
  if (!/^\d{12}$/.test(codigo)) {
    feedback("âŒ CÃ³digo deve ter 12 nÃºmeros!");
    return;
  }
  
  let nivel = parseInt(codigo.substring(0, 3));
  let rodada = parseInt(codigo.substring(3, 5));
  let mov = parseInt(codigo.substring(5, 8));
  let pts = parseInt(codigo.substring(8, 12));
  
  if (nivel < 1 || nivel > 3) {
    feedback("âŒ NÃ­vel invÃ¡lido!");
    return;
  }
  
  let totalRodadas = CONFIG[nivel].totalRodadas;
  if (rodada < 1 || rodada > totalRodadas) {
    feedback(`âŒ Rodada deve ser entre 1 e ${totalRodadas}!`);
    return;
  }
  
  nivelAtual = nivel;
  rodadaAtual = rodada;
  movimentos = mov;
  pontos = pts;
  
  gerarTabuleiro();
  desenhar();
  feedback("âœ… Progresso restaurado! Continue jogando.");
}

// =====================================================
// FUNÃ‡Ã•ES AUXILIARES
// =====================================================
function embaralhar(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function getQtdCores() { return CONFIG[nivelAtual].cores; }
function getMetaRodada() { return getQtdCores(); }
function getTotalRodadas() { return CONFIG[nivelAtual].totalRodadas; }
function getBonus() { return CONFIG[nivelAtual].bonus; }

function diagnosticar() {
  let qtdCores = getQtdCores();
  let contagem = {};
  for (let i = 0; i < qtdCores; i++) contagem[CORES[i]] = 0;
  
  for (let i = 0; i < 18; i++) {
    for (let j = 0; j < parafusos[i].length; j++) {
      let cor = parafusos[i][j];
      if (contagem[cor] !== undefined) contagem[cor]++;
    }
  }
  
  let msg = "ğŸ“Š CORES NO TABULEIRO:\n";
  for (let i = 0; i < qtdCores; i++) {
    let cor = CORES[i];
    let nome = NOMES_CORES[cor];
    msg += `${nome}: ${contagem[cor] || 0} porcas\n`;
  }
  alert(msg);
}

// =====================================================
// FUNÃ‡Ã•ES PRINCIPAIS DO JOGO
// =====================================================
function gerarTabuleiro() {
  let qtdCores = getQtdCores();
  let pool = [];
  for (let i = 0; i < qtdCores; i++) {
    for (let j = 0; j < CAPACIDADE; j++) pool.push(CORES[i]);
  }
  
  pool = embaralhar(pool);
  parafusos = Array(18).fill().map(() => []);
  
  for (let i = 0; i < 18; i++) {
    if (pool.length) parafusos[i].push(pool.pop());
  }
  
  let indices = embaralhar([...Array(18).keys()]);
  while (pool.length) {
    for (let idx of indices) {
      if (!pool.length) break;
      if (parafusos[idx].length < CAPACIDADE) {
        parafusos[idx].push(pool.pop());
      }
    }
  }
  
  parafusos = parafusos.map(p => embaralhar(p));
  processandoRodada = false;
  ultimaSequencia = [];
}

function contarCompletos() {
  let count = 0;
  for (let i = 0; i < 18; i++) if (estaCompleto(i)) count++;
  return count;
}

function verificarSequencia() {
  let maior = 0, atual = 0, indices = [], indicesAtuais = [];
  for (let i = 0; i < 18; i++) {
    if (estaCompleto(i)) {
      atual++;
      indicesAtuais.push(i);
      if (atual > maior) {
        maior = atual;
        indices = [...indicesAtuais];
      }
    } else { atual = 0; indicesAtuais = []; }
  }
  ultimaSequencia = indices;
  document.getElementById("sequenciaTamanho").textContent = maior;
  return { tamanho: maior, indices: indices };
}

function calcularBonusSequencia(tamanho) {
  if (tamanho >= 5) return 200;
  if (tamanho === 4) return 100;
  if (tamanho === 3) return 50;
  return 0;
}

function getBlocoTopo(idx) {
  if (!parafusos[idx]?.length) return 0;
  let cor = parafusos[idx][parafusos[idx].length - 1], count = 0;
  for (let i = parafusos[idx].length - 1; i >= 0 && parafusos[idx][i] === cor; i--) count++;
  return count;
}

function ajustarCor(hex, percent) {
  let r = parseInt(hex.substring(1, 3), 16);
  let g = parseInt(hex.substring(3, 5), 16);
  let b = parseInt(hex.substring(5, 7), 16);
  r = Math.max(0, Math.min(255, r + percent));
  g = Math.max(0, Math.min(255, g + percent));
  b = Math.max(0, Math.min(255, b + percent));
  return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
}

function desenhar() {
  let board = document.getElementById("board");
  board.innerHTML = "";
  
  document.getElementById("moves").textContent = movimentos;
  document.getElementById("score").textContent = pontos;
  
  let completos = contarCompletos();
  let meta = getMetaRodada();
  
  document.getElementById("completosRodada").textContent = completos;
  document.getElementById("metaRodada").textContent = meta;
  document.getElementById("progress-fill").style.width = Math.min(100, (completos / meta * 100)) + "%";
  
  document.getElementById("nivelAtual").textContent = `NÃ­vel ${nivelAtual}`;
  document.getElementById("desafioAtual").textContent = `Rodada ${rodadaAtual}/${getTotalRodadas()}`;
  
  let seq = verificarSequencia();
  
  parafusos.forEach((parafuso, idx) => {
    let div = document.createElement("div");
    div.className = "screw";
    if (selecionado === idx) div.classList.add("selected");
    if (estaCompleto(idx)) div.classList.add("locked");
    if (seq.indices.includes(idx)) div.classList.add("sequencia");
    
    div.onclick = () => cliqueParafuso(idx);
    
    for (let i = 0; i < parafuso.length; i++) {
      let nut = document.createElement("div");
      nut.className = "nut";
      nut.style.background = `linear-gradient(145deg, ${parafuso[i]}, ${ajustarCor(parafuso[i], -20)})`;
      nut.title = NOMES_CORES[parafuso[i]];
      div.appendChild(nut);
    }
    
    for (let i = parafuso.length; i < CAPACIDADE; i++) {
      let p = document.createElement("div");
      p.className = "nut-placeholder";
      div.appendChild(p);
    }
    
    board.appendChild(div);
  });
}

function estaCompleto(idx) {
  let p = parafusos[idx];
  return p.length === CAPACIDADE && p.every(c => c === p[0]);
}

function cliqueParafuso(idx) {
  if (processandoRodada) return;
  if (estaCompleto(idx)) { feedback("âŒ Parafuso completo!"); return; }
  
  if (selecionado === null) {
    if (parafusos[idx].length > 0) {
      selecionado = idx;
      desenhar();
    }
  } else {
    mover(selecionado, idx);
    selecionado = null;
    desenhar();
  }
}

function mover(origem, destino) {
  if (origem === destino || !parafusos[origem].length) return;
  
  let bloco = getBlocoTopo(origem);
  let espaco = CAPACIDADE - parafusos[destino].length;
  if (espaco < bloco) { feedback(`âŒ EspaÃ§o insuficiente!`); return; }
  
  let corOrigem = parafusos[origem][parafusos[origem].length - 1];
  let topoDestino = parafusos[destino].length ? parafusos[destino][parafusos[destino].length - 1] : null;
  
  if (topoDestino === null || topoDestino === corOrigem) {
    historico.push(JSON.stringify({
      parafusos: parafusos.map(p => [...p]),
      movimentos, pontos, rodadaAtual
    }));
    
    for (let i = 0; i < bloco; i++) {
      parafusos[destino].push(parafusos[origem].pop());
    }
    movimentos++;
    
    if (estaCompleto(destino)) {
      pontos += 20;
      let bonus = calcularBonusSequencia(verificarSequencia().tamanho);
      if (bonus) { pontos += bonus; feedback(`ğŸ† +${bonus} sequÃªncia!`, 2000); }
      else feedback(`âœ… +20`, 1000);
    } else if (bloco > 1) feedback(`ğŸ“¦ ${bloco} porcas`, 1000);
    
    desenhar();
    
    let completos = contarCompletos();
    if (completos >= getMetaRodada() && !processandoRodada) {
      processandoRodada = true;
      pontos += 50;
      feedback(`ğŸ¯ Rodada ${rodadaAtual} +50`, 2000);
      rodadaAtual++;
      
      if (rodadaAtual > getTotalRodadas()) {
        CONFIG[nivelAtual].completa = true;
        pontos += getBonus();
        feedback(`ğŸ† NÃ­vel ${nivelAtual} +${getBonus()}!`, 3000);
        setTimeout(() => {
          if (nivelAtual < 3) {
            nivelAtual++; rodadaAtual = 1; movimentos = 0; historico = [];
            selecionado = null; gerarTabuleiro(); desenhar();
            feedback(`ğŸ‰ NÃ­vel ${nivelAtual}!`);
          } else feedback("ğŸ† VITÃ“RIA TOTAL!", 4000);
        }, 2000);
      } else {
        setTimeout(() => { gerarTabuleiro(); desenhar(); feedback(`ğŸ”„ Rodada ${rodadaAtual}/${getTotalRodadas()}`); }, 1500);
      }
    }
  } else { feedback("âŒ Cores diferentes!"); selecionado = null; }
}

function desfazer() {
  if (processandoRodada) { feedback("â³ Aguarde..."); return; }
  if (!historico.length) { feedback("Nada"); return; }
  let est = JSON.parse(historico.pop());
  parafusos = est.parafusos.map(p => [...p]);
  movimentos = est.movimentos; pontos = est.pontos; rodadaAtual = est.rodadaAtual;
  selecionado = null; desenhar(); feedback("â†©ï¸ Desfeito");
}

function verificarSenha(nivel) {
  if (document.getElementById("senhaInput").value === SENHA_PROFESSOR) {
    nivelAtual = nivel; rodadaAtual = 1; movimentos = 0; historico = [];
    selecionado = null; processandoRodada = false; gerarTabuleiro(); desenhar();
    feedback(`ğŸ‘¨â€ğŸ« NÃ­vel ${nivel}`); fecharPainelProfessor();
  } else { feedback("âŒ Senha!"); document.getElementById("senhaInput").value = ""; }
}

function feedback(msg, t=1500) {
  let fb = document.querySelector(".feedback");
  if (fb) fb.remove();
  fb = document.createElement("div"); fb.className = "feedback"; fb.textContent = msg;
  document.body.appendChild(fb); setTimeout(() => fb.remove(), t);
}

function mostrarInstrucoes() { document.getElementById("instructions").style.display = "flex"; }
function fecharInstrucoes() { document.getElementById("instructions").style.display = "none"; }
function mostrarBNCC() { document.getElementById("bnccModal").style.display = "flex"; }
function fecharBNCC() { document.getElementById("bnccModal").style.display = "none"; }
function mostrarPainelProfessor() { document.getElementById("teacherPanel").style.display = "flex"; document.getElementById("senhaInput").value = ""; }
function fecharPainelProfessor() { document.getElementById("teacherPanel").style.display = "none"; }

function novoJogo() {
  nivelAtual = 1; rodadaAtual = 1;
  CONFIG[1].completa = CONFIG[2].completa = CONFIG[3].completa = false;
  movimentos = 0; pontos = 0; historico = []; selecionado = null; processandoRodada = false;
  gerarTabuleiro(); desenhar(); feedback(`ğŸŒŸ NÃ­vel 1 - Rodada 1/${getTotalRodadas()}`);
}

// =====================================================
// AVISO AO FECHAR
// =====================================================
window.addEventListener('beforeunload', function (e) {
  if (pontos > 0 || movimentos > 0) {
    e.preventDefault();
    e.returnValue = '';
    return '';
  }
});

// =====================================================
// INICIALIZAÃ‡ÃƒO
// =====================================================
novoJogo();

// Exportar funÃ§Ãµes
window.novoJogo = novoJogo;
window.desfazer = desfazer;
window.mostrarInstrucoes = mostrarInstrucoes;
window.fecharInstrucoes = fecharInstrucoes;
window.mostrarBNCC = mostrarBNCC;
window.fecharBNCC = fecharBNCC;
window.mostrarPainelProfessor = mostrarPainelProfessor;
window.fecharPainelProfessor = fecharPainelProfessor;
window.verificarSenha = verificarSenha;
window.diagnosticar = diagnosticar;
window.gerarCodigo = gerarCodigo;
window.restaurarCodigo = restaurarCodigo;
</script>
</body>
</html>
