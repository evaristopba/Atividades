<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Parafusos e Porcas - C√≥digo 13 d√≠gitos</title>
<style>
/* =====================================================
   ESTILOS (MANTIDOS IGUAIS)
   ===================================================== */
* {
  box-sizing: border-box;
  user-select: none;
}

html, body {
  height: 100%;
  margin: 0;
  padding: 10px;
  overflow: hidden;
}

body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
  text-align: center;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

h1 {
  color: white;
  margin: 5px 0 10px;
  font-size: 2rem;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
  flex-shrink: 0;
}

#topbar {
  background: rgba(255, 255, 255, 0.95);
  padding: 8px 12px;
  border-radius: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 10px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(10px);
  border: 2px solid #f1c40f;
  flex-shrink: 0;
  min-height: 48px;
}

.info-item, .nivel-badge, .desafio-info, #sequencia-info {
  background: #ecf0f1;
  padding: 4px 10px;
  border-radius: 30px;
  font-weight: 700;
  color: #2c3e50;
  box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
  font-size: 0.85rem;
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  gap: 3px;
  line-height: 1.2;
  position: relative;
}

.info-item[title]:hover::after, 
.nivel-badge[title]:hover::after, 
.desafio-info[title]:hover::after, 
#sequencia-info[title]:hover::after,
button[title]:hover::after {
  content: attr(title);
  position: absolute;
  bottom: 125%;
  left: 50%;
  transform: translateX(-50%);
  background: #2c3e50;
  color: white;
  padding: 4px 8px;
  border-radius: 15px;
  font-size: 0.7rem;
  white-space: nowrap;
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  border: 1px solid #f1c40f;
  z-index: 1000;
  pointer-events: none;
}

button, select {
  padding: 4px 10px;
  border-radius: 30px;
  border: none;
  background: #3498db;
  font-weight: 700;
  cursor: pointer;
  color: white;
  font-size: 0.85rem;
  box-shadow: 0 2px 0 #2980b9, 0 3px 6px rgba(0, 0, 0, 0.2);
  transition: all 0.1s;
  white-space: nowrap;
  line-height: 1.2;
  position: relative;
}

button:hover, select:hover {
  background: #2980b9;
  transform: translateY(-1px);
  box-shadow: 0 3px 0 #1f618d, 0 4px 8px rgba(0, 0, 0, 0.2);
}

button:active {
  transform: translateY(2px);
  box-shadow: 0 1px 0 #1f618d;
}

#board {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 8px;
  max-width: 1000px;
  margin: 0 auto;
  width: 100%;
  flex: 1;
  min-height: 0;
  overflow: hidden;
}

.screw {
  background: linear-gradient(145deg, #bdc3c7, #95a5a6);
  border-radius: 18px 18px 6px 6px;
  padding: 4px 2px 6px;
  height: 100%;
  max-height: 180px;
  display: flex;
  flex-direction: column-reverse;
  align-items: center;
  justify-content: flex-start;
  border: 3px solid #7f8c8d;
  box-shadow: 0 4px 0 #4a5a5a, 0 6px 10px rgba(0, 0, 0, 0.4);
  position: relative;
  cursor: pointer;
  transition: all 0.1s;
  background-image: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.3) 0%, transparent 30%);
}

.screw::after {
  content: "";
  position: absolute;
  bottom: -2px;
  left: 50%;
  transform: translateX(-50%);
  width: 30px;
  height: 10px;
  background: linear-gradient(90deg, #7f8c8d, #4a5a5a, #7f8c8d);
  border-radius: 4px 4px 0 0;
  border: 2px solid #2c3e50;
  border-bottom: none;
  box-shadow: inset 0 2px 2px rgba(0, 0, 0, 0.3);
}

.screw.selected {
  border: 4px solid #f1c40f;
  box-shadow: 0 0 0 3px #f7dc6f, 0 4px 0 #b7950b;
}

.screw.sequencia {
  border: 3px solid #f39c12;
  box-shadow: 0 0 8px #f39c12, 0 4px 0 #b7950b;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0% { border-color: #f39c12; }
  50% { border-color: #f1c40f; }
  100% { border-color: #f39c12; }
}

.nut {
  width: 32px;
  height: 32px;
  margin: 1px 0;
  border: 2px solid #2c3e50;
  box-shadow: 0 2px 0 #1a2632, 0 3px 5px rgba(0, 0, 0, 0.3);
  transition: 0.05s;
  flex-shrink: 0;
  background: linear-gradient(145deg, #ecf0f1, #bdc3c7);
  clip-path: polygon(25% 0%, 75% 0%, 100% 25%, 100% 75%, 75% 100%, 25% 100%, 0% 75%, 0% 25%);
  position: relative;
}

.nut::after {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 12px;
  height: 12px;
  background: linear-gradient(145deg, #7f8c8d, #4a5a5a);
  border-radius: 50%;
  border: 2px solid #2c3e50;
}

.nut::before {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 4px;
  height: 4px;
  background: #f1c40f;
  border-radius: 50%;
  z-index: 2;
  border: 1px solid #b7950b;
}

.nut-placeholder {
  width: 32px;
  height: 32px;
  margin: 1px 0;
  visibility: hidden;
  flex-shrink: 0;
}

.locked {
  border: 3px solid #27ae60 !important;
  background: linear-gradient(145deg, #d5f5e3, #a9dfbf) !important;
  box-shadow: 0 4px 0 #1e8449, 0 6px 10px rgba(0, 0, 0, 0.3) !important;
}

.locked::after {
  content: "‚úì";
  position: absolute;
  top: -4px;
  right: -4px;
  background: #27ae60;
  color: white;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 11px;
  border: 2px solid #f1c40f;
  z-index: 10;
}

#progress-bar {
  width: 100px;
  height: 8px;
  background: #ecf0f1;
  border-radius: 20px;
  overflow: hidden;
  border: 1px solid #2980b9;
  flex-shrink: 0;
}

#progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #27ae60, #2ecc71);
  width: 0%;
  transition: width 0.3s;
}

.feedback {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #2c3e50;
  color: white;
  padding: 8px 20px;
  border-radius: 30px;
  font-size: 0.9rem;
  font-weight: bold;
  box-shadow: 0 5px 15px black;
  z-index: 1000;
  border: 2px solid #f1c40f;
}

#instructions, #teacherPanel, #bnccModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(5px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.modal-content {
  background: white;
  padding: 20px;
  border-radius: 25px;
  max-width: 450px;
  max-height: 80vh;
  overflow-y: auto;
  border: 4px solid #f1c40f;
  text-align: left;
}

.close-btn {
  float: right;
  background: #e74c3c;
  color: white;
  border: none;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  font-size: 15px;
  cursor: pointer;
  border: 2px solid #c0392b;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-btn:hover {
  background: #c0392b;
}

.teacher-input {
  padding: 5px;
  font-size: 0.9rem;
  border-radius: 30px;
  border: 2px solid #2c3e50;
  width: 150px;
  text-align: center;
  margin-bottom: 8px;
}

.diagnostico-btn {
  background: #e67e22;
  margin-top: 10px;
  width: 100%;
  font-size: 0.85rem;
  padding: 6px;
}

.diagnostico-btn:hover {
  background: #d35400;
}

.bncc-section {
  background: #ecf0f1;
  border-radius: 12px;
  padding: 10px;
  margin: 10px 0;
  border-left: 5px solid #27ae60;
}

.bncc-section h3 {
  color: #27ae60;
  margin-top: 0;
  font-size: 1rem;
}

.bncc-code {
  background: #2c3e50;
  color: white;
  padding: 2px 6px;
  border-radius: 20px;
  display: inline-block;
  font-weight: bold;
  margin: 2px 0;
  font-size: 0.8rem;
}
</style>
</head>
<body>

<h1>üîß PARAFUSOS E PORCAS üî©</h1>

<div id="topbar">
  <div class="info-item" title="Pontua√ß√£o total">‚≠ê <span id="score">0</span></div>
  <div class="info-item" title="N√∫mero de movimentos realizados">üîÑ <span id="moves">0</span></div>
  <div class="info-item" title="Parafusos completos na rodada atual">üîí <span id="completosRodada">0</span>/<span id="metaRodada">6</span></div>
  <div class="nivel-badge" id="nivelAtual" title="N√≠vel atual">N√≠vel 1</div>
  <div class="desafio-info" id="desafioAtual" title="Rodada atual / Total de rodadas">Rodada 1/10</div>
  <div id="sequencia-info" title="Maior sequ√™ncia de parafusos completos consecutivos">üèÜ Sequ√™ncia: <span id="sequenciaTamanho">0</span></div>
  <div id="progress-bar" title="Progresso da rodada atual"><div id="progress-fill"></div></div>
  <button onclick="gerarCodigo()" title="Gerar c√≥digo num√©rico (13 d√≠gitos) para continuar depois">üìã Gerar C√≥digo</button>
  <button onclick="restaurarCodigo()" title="Restaurar progresso digitando o c√≥digo (12 ou 13 d√≠gitos)">üîÑ Restaurar</button>
  <button onclick="desfazer()" title="Desfazer o √∫ltimo movimento">‚Ü©Ô∏è Desfazer</button>
  <button onclick="mostrarInstrucoes()" title="Ver instru√ß√µes do jogo">üìò Ajuda</button>
  <button onclick="mostrarPainelProfessor()" title="Abrir painel do professor">üë®‚Äçüè´ Professor</button>
</div>

<div id="board"></div>

<!-- Modal de Instru√ß√µes -->
<div id="instructions">
  <div class="modal-content">
    <button class="close-btn" onclick="fecharInstrucoes()" title="Fechar">‚úï</button>
    <h2 style="margin-top:0; color:#2c3e50;">üìò COMO JOGAR</h2>
    
    <h3>üéØ Objetivo</h3>
    <p>Organize todas as porcas coloridas em parafusos, formando pilhas de <strong>4 porcas da mesma cor</strong>.</p>
    
    <h3>üéÆ Regras</h3>
    <ul>
      <li><strong>Clique</strong> em um parafuso para selecionar a porca do <strong>TOPO</strong></li>
      <li><strong>Clique</strong> em outro parafuso para mover a porca</li>
      <li>S√≥ pode mover se o destino estiver <strong>vazio</strong> ou com a <strong>mesma cor</strong> no topo</li>
      <li>Cada parafuso suporta no m√°ximo <strong>4 porcas</strong></li>
      <li><strong>üö´ Parafusos completos n√£o podem ser movidos!</strong></li>
    </ul>
    
    <h3>üìã C√ìDIGO DE RESTAURA√á√ÉO (13 D√çGITOS)</h3>
    <ul>
      <li><strong>üìå No final da aula</strong>, clique em "Gerar C√≥digo"</li>
      <li><strong>‚úèÔ∏è Anote o n√∫mero no caderno</strong> (13 d√≠gitos, s√≥ n√∫meros!)</li>
      <li><strong>üîÑ Na pr√≥xima aula</strong>, clique em "Restaurar" e digite o n√∫mero</li>
      <li>‚úÖ C√≥digos antigos de 12 d√≠gitos tamb√©m funcionam!</li>
    </ul>
    
    <h3>üìä Formato do c√≥digo:</h3>
    <ul>
      <li><strong>3 d√≠gitos:</strong> N√≠vel (001 a 003)</li>
      <li><strong>2 d√≠gitos:</strong> Rodada (01 a 35)</li>
      <li><strong>3 d√≠gitos:</strong> Movimentos (000 a 999)</li>
      <li><strong>5 d√≠gitos:</strong> Pontos (00000 a 99999)</li>
    </ul>
    
    <h3>üèÜ B√¥nus de Sequ√™ncia</h3>
    <ul>
      <li><strong>Sequ√™ncia perfeita:</strong> parafusos completos em ordem crescente (1,2,3...)</li>
      <li><strong>Sem vazios:</strong> n√£o pode haver parafusos vazios entre eles</li>
      <li><strong>Pontua√ß√£o:</strong> +50pts para sequ√™ncia de 3, +100pts para 4, +200pts para 5+</li>
    </ul>
    
    <h3>üìä Progress√£o</h3>
    <ul>
      <li><strong>N√≠vel 1:</strong> 6 cores | 10 rodadas | meta: 6 parafusos/rodada</li>
      <li><strong>N√≠vel 2:</strong> 9 cores | 20 rodadas | meta: 9 parafusos/rodada</li>
      <li><strong>N√≠vel 3:</strong> 12 cores | 35 rodadas | meta: 12 parafusos/rodada</li>
    </ul>
  </div>
</div>

<!-- Modal BNCC -->
<div id="bnccModal">
  <div class="modal-content">
    <button class="close-btn" onclick="fecharBNCC()" title="Fechar">‚úï</button>
    <h2 style="margin-top:0; color:#2c3e50;">üìö BASE NACIONAL COMUM CURRICULAR</h2>
    
    <div class="bncc-section">
      <h3>üå± EDUCA√á√ÉO INFANTIL</h3>
      <p><strong>Campo de Experi√™ncia:</strong> Espa√ßos, tempos, quantidades, rela√ß√µes e transforma√ß√µes</p>
      <span class="bncc-code">EI03ET01</span> Estabelecer rela√ß√µes de compara√ß√£o entre objetos<br>
      <span class="bncc-code">EI03ET05</span> Classificar objetos e figuras de acordo com suas propriedades
    </div>
    
    <div class="bncc-section">
      <h3>üìê ENSINO FUNDAMENTAL - MATEM√ÅTICA</h3>
      <p><strong>Unidade Tem√°tica:</strong> Probabilidade e estat√≠stica / Grandezas e medidas</p>
      <span class="bncc-code">EF01MA09</span> Organizar e ordenar objetos familiares<br>
      <span class="bncc-code">EF02MA18</span> Indicar a dire√ß√£o e sentido em deslocamentos<br>
      <span class="bncc-code">EF03MA25</span> Identificar regularidades em sequ√™ncias
    </div>
    
    <div class="bncc-section">
      <h3>üß† HABILIDADES DESENVOLVIDAS</h3>
      <ul>
        <li><strong>Racioc√≠nio l√≥gico:</strong> planejar movimentos para atingir o objetivo</li>
        <li><strong>Classifica√ß√£o:</strong> agrupar porcas por cor</li>
        <li><strong>Sequencia√ß√£o:</strong> ordem de empilhamento (base ao topo)</li>
        <li><strong>Resolu√ß√£o de problemas:</strong> encontrar solu√ß√µes para completar os parafusos</li>
        <li><strong>Persist√™ncia:</strong> completar m√∫ltiplas rodadas e n√≠veis</li>
      </ul>
    </div>
    
    <p style="font-style: italic; color: #27ae60; text-align: center;">"Aprender brincando √© a forma mais eficaz de fixar o conhecimento!"</p>
  </div>
</div>

<!-- Modal do Professor -->
<div id="teacherPanel">
  <div class="modal-content">
    <button class="close-btn" onclick="fecharPainelProfessor()" title="Fechar">‚úï</button>
    <h2 style="margin-top:0; color:#2c3e50;">üë®‚Äçüè´ PAINEL DO PROFESSOR</h2>
    
    <p>üîì <strong>Desbloquear n√≠veis (senha: P2026):</strong></p>
    <input type="password" id="senhaInput" class="teacher-input" placeholder="Digite a senha" maxlength="5">
    <div style="margin: 15px 0; text-align: center;">
      <button onclick="verificarSenha(1)" style="margin:3px;" title="Desbloquear N√≠vel 1 (6 cores)">üîì N√≠vel 1</button>
      <button onclick="verificarSenha(2)" style="margin:3px;" title="Desbloquear N√≠vel 2 (9 cores)">üîì N√≠vel 2</button>
      <button onclick="verificarSenha(3)" style="margin:3px;" title="Desbloquear N√≠vel 3 (12 cores)">üîì N√≠vel 3</button>
    </div>
    
    <hr style="margin: 20px 0; border: 1px solid #ecf0f1;">
    
    <p>üîç <strong>Ferramentas de diagn√≥stico:</strong></p>
    <button onclick="diagnosticar()" class="diagnostico-btn" title="Mostra a contagem de cada cor no tabuleiro">üìä Diagnosticar distribui√ß√£o de cores</button>
    <p style="font-size: 0.85rem; color: #7f8c8d; margin-top: 10px;">
      Mostra quantas porcas de cada cor existem no tabuleiro atual
    </p>
  </div>
</div>

<script>
// =====================================================
// CONSTANTES E CONFIGURA√á√ïES
// =====================================================

const CORES = [
  "#ef4444", "#3b82f6", "#22c55e", "#f59e0b", "#a855f7",
  "#ec4899", "#14b8a6", "#f97316", "#8b5cf6", "#06b6d4",
  "#d946ef", "#84cc16", "#f43f5e", "#10b981", "#6366f1"
];

const NOMES_CORES = {
  "#ef4444": "Vermelho", "#3b82f6": "Azul", "#22c55e": "Verde",
  "#f59e0b": "Laranja", "#a855f7": "Roxo", "#ec4899": "Rosa",
  "#14b8a6": "Turquesa", "#f97316": "Laranja escuro", "#8b5cf6": "Violeta",
  "#06b6d4": "Ciano", "#d946ef": "Magenta", "#84cc16": "Lima",
  "#f43f5e": "Ros√™", "#10b981": "Esmeralda", "#6366f1": "√çndigo"
};

const CAPACIDADE = 4;
const SENHA_PROFESSOR = "P2026";

const CONFIG = {
  1: { cores: 6, totalRodadas: 10, bonus: 100, completa: false },
  2: { cores: 9, totalRodadas: 20, bonus: 200, completa: false },
  3: { cores: 12, totalRodadas: 35, bonus: 400, completa: false }
};

// =====================================================
// ESTADO GLOBAL DO JOGO
// =====================================================
let nivelAtual = 1;
let rodadaAtual = 1;
let parafusos = [];
let historico = [];
let movimentos = 0;
let pontos = 0;
let selecionado = null;
let processandoRodada = false;
let ultimaSequencia = [];

// =====================================================
// FUN√á√ïES DE C√ìDIGO (ATUALIZADO PARA 13 D√çGITOS)
// =====================================================

/**
 * Gera um c√≥digo num√©rico de 13 d√≠gitos (compat√≠vel com vers√£o anterior)
 * Formato: NNN RR MMM PPPPP (3+2+3+5 = 13 d√≠gitos)
 */
function gerarCodigo() {
  // Converte cada valor para string com zeros √† esquerda
  let nivelStr = nivelAtual.toString().padStart(3, '0');
  let rodadaStr = rodadaAtual.toString().padStart(2, '0');
  let movStr = movimentos.toString().padStart(3, '0');
  let pontosStr = pontos.toString().padStart(5, '0'); // AGORA COM 5 D√çGITOS!
  
  // C√≥digo sem espa√ßos (13 d√≠gitos)
  let codigo = nivelStr + rodadaStr + movStr + pontosStr;
  
  // Vers√£o formatada para facilitar a leitura
  let codigoFormatado = `${nivelStr} ${rodadaStr} ${movStr} ${pontosStr}`;
  
  // Prepara mensagem para o aluno
  let mensagem = "";
  mensagem += "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n";
  mensagem += "‚ïë   C√ìDIGO DE RESTAURA√á√ÉO       ‚ïë\n";
  mensagem += "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n";
  mensagem += "‚ïë                                 ‚ïë\n";
  mensagem += "‚ïë     üìù " + codigoFormatado + "     ‚ïë\n";
  mensagem += "‚ïë                                 ‚ïë\n";
  mensagem += "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n";
  mensagem += "‚ïë N√≠vel: " + nivelAtual + "  Rodada: " + rodadaAtual + "/" + getTotalRodadas() + "\n";
  mensagem += "‚ïë Pontos: " + pontos + "  Movimentos: " + movimentos + "\n";
  mensagem += "‚ïë Parafusos: " + contarCompletos() + "/18\n";
  mensagem += "‚ïë                                 ‚ïë\n";
  mensagem += "‚ïë ANOTE NO CADERNO!               ‚ïë\n";
  mensagem += "‚ïë S√£o 13 n√∫meros.                  ‚ïë\n";
  mensagem += "‚ïë C√≥digos antigos de 12 n√∫meros   ‚ïë\n";
  mensagem += "‚ïë tamb√©m funcionam!                ‚ïë\n";
  mensagem += "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù";
  
  alert(mensagem);
  
  // Tenta copiar para √°rea de transfer√™ncia
  try {
    navigator.clipboard.writeText(codigo);
    alert("üìã C√≥digo copiado para √°rea de transfer√™ncia!");
  } catch (e) {}
}

/**
 * Restaura o progresso a partir de um c√≥digo (12 ou 13 d√≠gitos)
 */
function restaurarCodigo() {
  let codigo = prompt("Digite o c√≥digo (12 ou 13 n√∫meros):");
  if (!codigo) return;
  
  // Remove espa√ßos, tra√ßos, pontos
  codigo = codigo.replace(/[-\s.]/g, '');
  
  // =====================================================
  // COMPATIBILIDADE COM C√ìDIGOS ANTIGOS (12 D√çGITOS)
  // =====================================================
  if (codigo.length === 12) {
    // Formato antigo: NNN RR MMM PPPP
    let nivel = parseInt(codigo.substring(0, 3));
    let rodada = parseInt(codigo.substring(3, 5));
    let mov = parseInt(codigo.substring(5, 8));
    let pts = parseInt(codigo.substring(8, 12));
    
    // Valida√ß√£o
    if (nivel >= 1 && nivel <= 3 && 
        rodada >= 1 && rodada <= CONFIG[nivel].totalRodadas &&
        mov >= 0 && mov <= 999 &&
        pts >= 0 && pts <= 9999) {
      
      nivelAtual = nivel;
      rodadaAtual = rodada;
      movimentos = mov;
      pontos = pts;
      
      gerarTabuleiro();
      desenhar();
      feedback("‚úÖ C√≥digo antigo (12 d√≠gitos) restaurado com sucesso!");
      return;
    } else {
      feedback("‚ùå C√≥digo inv√°lido!");
      return;
    }
  }
  
  // =====================================================
  // FORMATO NOVO (13 D√çGITOS)
  // =====================================================
  if (codigo.length === 13) {
    // Verifica se tem apenas n√∫meros
    if (!/^\d+$/.test(codigo)) {
      feedback("‚ùå C√≥digo deve conter apenas n√∫meros!");
      return;
    }
    
    // Extrai as partes
    let nivel = parseInt(codigo.substring(0, 3));
    let rodada = parseInt(codigo.substring(3, 5));
    let mov = parseInt(codigo.substring(5, 8));
    let pts = parseInt(codigo.substring(8, 13));
    
    // Valida os valores
    if (nivel < 1 || nivel > 3) {
      feedback("‚ùå N√≠vel inv√°lido! Deve ser 1, 2 ou 3.");
      return;
    }
    
    let totalRodadas = CONFIG[nivel].totalRodadas;
    if (rodada < 1 || rodada > totalRodadas) {
      feedback("‚ùå Rodada deve ser entre 1 e " + totalRodadas + "!");
      return;
    }
    
    if (mov < 0 || mov > 999) {
      feedback("‚ùå Movimentos inv√°lidos! M√°ximo 999.");
      return;
    }
    
    if (pts < 0 || pts > 99999) {
      feedback("‚ùå Pontua√ß√£o inv√°lida! M√°ximo 99.999.");
      return;
    }
    
    // Restaura o estado do jogo
    nivelAtual = nivel;
    rodadaAtual = rodada;
    movimentos = mov;
    pontos = pts;
    
    gerarTabuleiro();
    desenhar();
    feedback("‚úÖ Progresso restaurado com sucesso!");
    return;
  }
  
  // Se chegou aqui, o c√≥digo tem tamanho inv√°lido
  feedback("‚ùå C√≥digo deve ter 12 ou 13 n√∫meros!");
}

// =====================================================
// DEMAIS FUN√á√ïES (mantidas da vers√£o anterior)
// =====================================================

function embaralhar(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function getQtdCores() { return CONFIG[nivelAtual].cores; }
function getMetaRodada() { return getQtdCores(); }
function getTotalRodadas() { return CONFIG[nivelAtual].totalRodadas; }
function getBonus() { return CONFIG[nivelAtual].bonus; }

function diagnosticar() {
  let qtdCores = getQtdCores();
  let contagem = {};
  for (let i = 0; i < qtdCores; i++) contagem[CORES[i]] = 0;
  
  for (let i = 0; i < 18; i++) {
    for (let j = 0; j < parafusos[i].length; j++) {
      let cor = parafusos[i][j];
      if (contagem[cor] !== undefined) contagem[cor]++;
    }
  }
  
  let msg = "üìä DIAGN√ìSTICO - CORES NO TABULEIRO:\n\n";
  for (let i = 0; i < qtdCores; i++) {
    let cor = CORES[i];
    let nome = NOMES_CORES[cor];
    msg += nome + ": " + (contagem[cor] || 0) + " porcas\n";
  }
  
  let total = 0;
  for (let i = 0; i < qtdCores; i++) total += contagem[CORES[i]] || 0;
  
  msg += "\nTotal: " + total + " porcas";
  msg += "\nEsperado: " + (qtdCores * 4) + " porcas";
  alert(msg);
}

function gerarTabuleiro() {
  let qtdCores = getQtdCores();
  let pool = [];
  for (let i = 0; i < qtdCores; i++) {
    for (let j = 0; j < CAPACIDADE; j++) pool.push(CORES[i]);
  }
  
  pool = embaralhar(pool);
  parafusos = Array(18).fill().map(() => []);
  
  for (let i = 0; i < 18; i++) {
    if (pool.length) parafusos[i].push(pool.pop());
  }
  
  let indices = embaralhar([...Array(18).keys()]);
  while (pool.length) {
    for (let idx of indices) {
      if (!pool.length) break;
      if (parafusos[idx].length < CAPACIDADE) {
        parafusos[idx].push(pool.pop());
      }
    }
  }
  
  parafusos = parafusos.map(p => embaralhar(p));
  processandoRodada = false;
  ultimaSequencia = [];
}

function contarCompletos() {
  let count = 0;
  for (let i = 0; i < 18; i++) if (estaCompleto(i)) count++;
  return count;
}

function verificarSequencia() {
  let maior = 0, atual = 0, indices = [], indicesAtuais = [];
  for (let i = 0; i < 18; i++) {
    if (estaCompleto(i)) {
      atual++;
      indicesAtuais.push(i);
      if (atual > maior) {
        maior = atual;
        indices = [...indicesAtuais];
      }
    } else { atual = 0; indicesAtuais = []; }
  }
  ultimaSequencia = indices;
  document.getElementById("sequenciaTamanho").textContent = maior;
  return { tamanho: maior, indices: indices };
}

function calcularBonusSequencia(tamanho) {
  if (tamanho >= 5) return 200;
  if (tamanho === 4) return 100;
  if (tamanho === 3) return 50;
  return 0;
}

function getBlocoTopo(idx) {
  if (idx === null || parafusos[idx].length === 0) return 0;
  let cor = parafusos[idx][parafusos[idx].length - 1];
  let count = 0;
  for (let i = parafusos[idx].length - 1; i >= 0 && parafusos[idx][i] === cor; i--) count++;
  return count;
}

function ajustarCor(hex, percent) {
  let r = parseInt(hex.substring(1, 3), 16);
  let g = parseInt(hex.substring(3, 5), 16);
  let b = parseInt(hex.substring(5, 7), 16);
  r = Math.max(0, Math.min(255, r + percent));
  g = Math.max(0, Math.min(255, g + percent));
  b = Math.max(0, Math.min(255, b + percent));
  return "#" + r.toString(16).padStart(2, '0') + g.toString(16).padStart(2, '0') + b.toString(16).padStart(2, '0');
}

function desenhar() {
  let board = document.getElementById("board");
  board.innerHTML = "";
  
  document.getElementById("moves").textContent = movimentos;
  document.getElementById("score").textContent = pontos;
  
  let completos = contarCompletos();
  let meta = getMetaRodada();
  
  document.getElementById("completosRodada").textContent = completos;
  document.getElementById("metaRodada").textContent = meta;
  
  let progresso = (completos / meta) * 100;
  if (progresso > 100) progresso = 100;
  document.getElementById("progress-fill").style.width = progresso + "%";
  
  document.getElementById("nivelAtual").textContent = "N√≠vel " + nivelAtual;
  document.getElementById("desafioAtual").textContent = "Rodada " + rodadaAtual + "/" + getTotalRodadas();
  
  let seq = verificarSequencia();
  
  for (let idx = 0; idx < 18; idx++) {
    let parafuso = parafusos[idx];
    let div = document.createElement("div");
    div.className = "screw";
    
    if (selecionado === idx) div.classList.add("selected");
    if (estaCompleto(idx)) div.classList.add("locked");
    if (seq.indices.includes(idx)) div.classList.add("sequencia");
    
    div.onclick = (function(index) {
      return function() { cliqueParafuso(index); };
    })(idx);
    
    for (let i = 0; i < parafuso.length; i++) {
      let nut = document.createElement("div");
      nut.className = "nut";
      nut.style.background = "linear-gradient(145deg, " + parafuso[i] + ", " + ajustarCor(parafuso[i], -20) + ")";
      nut.title = NOMES_CORES[parafuso[i]];
      div.appendChild(nut);
    }
    
    for (let i = parafuso.length; i < CAPACIDADE; i++) {
      let placeholder = document.createElement("div");
      placeholder.className = "nut-placeholder";
      div.appendChild(placeholder);
    }
    
    board.appendChild(div);
  }
}

function estaCompleto(idx) {
  let p = parafusos[idx];
  if (p.length !== CAPACIDADE) return false;
  let primeiraCor = p[0];
  for (let i = 1; i < p.length; i++) if (p[i] !== primeiraCor) return false;
  return true;
}

function cliqueParafuso(idx) {
  if (processandoRodada) return;
  if (estaCompleto(idx)) { feedback("‚ùå Parafuso j√° est√° completo!"); return; }
  
  if (selecionado === null) {
    if (parafusos[idx].length > 0) {
      selecionado = idx;
      desenhar();
    }
  } else {
    mover(selecionado, idx);
    selecionado = null;
    desenhar();
  }
}

function mover(origem, destino) {
  if (origem === destino) return;
  if (parafusos[origem].length === 0) return;
  
  let bloco = getBlocoTopo(origem);
  let espaco = CAPACIDADE - parafusos[destino].length;
  
  if (espaco < bloco) {
    feedback("‚ùå Espa√ßo insuficiente! Cabe apenas " + espaco);
    return;
  }
  
  let corOrigem = parafusos[origem][parafusos[origem].length - 1];
  let topoDestino = null;
  if (parafusos[destino].length > 0) topoDestino = parafusos[destino][parafusos[destino].length - 1];
  
  if (topoDestino === null || topoDestino === corOrigem) {
    let estadoParaHistorico = {
      parafusos: parafusos.map(p => [...p]),
      movimentos: movimentos,
      pontos: pontos,
      rodadaAtual: rodadaAtual
    };
    historico.push(JSON.stringify(estadoParaHistorico));
    
    for (let i = 0; i < bloco; i++) {
      let porca = parafusos[origem].pop();
      parafusos[destino].push(porca);
    }
    
    movimentos++;
    
    if (estaCompleto(destino)) {
      pontos += 20;
      let seq = verificarSequencia();
      let bonus = calcularBonusSequencia(seq.tamanho);
      if (bonus > 0) {
        pontos += bonus;
        feedback("üèÜ SEQU√äNCIA DE " + seq.tamanho + "! +" + bonus + " pontos", 3000);
      } else {
        feedback("‚úÖ Parafuso " + (destino + 1) + " completo! +20 pontos");
      }
    } else if (bloco > 1) {
      feedback("üì¶ Movidas " + bloco + " porcas de uma vez!", 1500);
    }
    
    desenhar();
    
    let completos = contarCompletos();
    let meta = getMetaRodada();
    
    if (completos >= meta && !processandoRodada) {
      processandoRodada = true;
      pontos += 50;
      feedback("üéØ RODADA " + rodadaAtual + " COMPLETA! +50 pontos", 3000);
      rodadaAtual++;
      
      if (rodadaAtual > getTotalRodadas()) {
        CONFIG[nivelAtual].completa = true;
        let bonus = getBonus();
        pontos += bonus;
        feedback("üèÜ N√çVEL " + nivelAtual + " COMPLETO! +" + bonus + " pontos!", 4000);
        
        setTimeout(function() {
          if (nivelAtual < 3) {
            nivelAtual++;
            rodadaAtual = 1;
            movimentos = 0;
            historico = [];
            selecionado = null;
            gerarTabuleiro();
            desenhar();
            feedback("üéâ N√çVEL " + nivelAtual + "! Rodada 1/" + getTotalRodadas());
          } else {
            feedback("üéâ PARAB√âNS! VOC√ä VENCEU TODAS AS RODADAS!", 5000);
          }
        }, 2000);
      } else {
        setTimeout(function() {
          gerarTabuleiro();
          desenhar();
          feedback("üîÑ Rodada " + rodadaAtual + "/" + getTotalRodadas());
        }, 1500);
      }
    }
  } else {
    feedback("‚ùå Cores diferentes!");
    selecionado = null;
  }
}

function desfazer() {
  if (processandoRodada) { feedback("‚è≥ Aguarde..."); return; }
  if (historico.length === 0) { feedback("Nada para desfazer"); return; }
  let estado = JSON.parse(historico.pop());
  parafusos = estado.parafusos.map(p => [...p]);
  movimentos = estado.movimentos;
  pontos = estado.pontos;
  rodadaAtual = estado.rodadaAtual;
  selecionado = null;
  desenhar();
  feedback("‚Ü©Ô∏è Movimento desfeito");
}

function verificarSenha(nivel) {
  let senha = document.getElementById("senhaInput").value;
  if (senha === SENHA_PROFESSOR) {
    nivelAtual = nivel;
    rodadaAtual = 1;
    movimentos = 0;
    historico = [];
    selecionado = null;
    processandoRodada = false;
    gerarTabuleiro();
    desenhar();
    feedback("üë®‚Äçüè´ N√≠vel " + nivel + " desbloqueado!");
    fecharPainelProfessor();
  } else {
    feedback("‚ùå Senha incorreta!");
    document.getElementById("senhaInput").value = "";
  }
}

function feedback(msg, tempo) {
  if (tempo === undefined) tempo = 2000;
  let fb = document.querySelector(".feedback");
  if (fb) fb.remove();
  fb = document.createElement("div");
  fb.className = "feedback";
  fb.textContent = msg;
  document.body.appendChild(fb);
  setTimeout(function() { fb.remove(); }, tempo);
}

function mostrarInstrucoes() { document.getElementById("instructions").style.display = "flex"; }
function fecharInstrucoes() { document.getElementById("instructions").style.display = "none"; }
function mostrarBNCC() { document.getElementById("bnccModal").style.display = "flex"; }
function fecharBNCC() { document.getElementById("bnccModal").style.display = "none"; }
function mostrarPainelProfessor() { 
  document.getElementById("teacherPanel").style.display = "flex"; 
  document.getElementById("senhaInput").value = ""; 
}
function fecharPainelProfessor() { document.getElementById("teacherPanel").style.display = "none"; }

function novoJogo() {
  if (pontos > 0 || movimentos > 0) {
    if (!confirm("Tem certeza? Todo progresso atual ser√° perdido!")) return;
  }
  nivelAtual = 1;
  rodadaAtual = 1;
  CONFIG[1].completa = CONFIG[2].completa = CONFIG[3].completa = false;
  movimentos = 0;
  pontos = 0;
  historico = [];
  selecionado = null;
  processandoRodada = false;
  gerarTabuleiro();
  desenhar();
  feedback("üåü N√≠vel 1 - Rodada 1/" + getTotalRodadas());
}

// =====================================================
// AVISO AO FECHAR
// =====================================================
window.addEventListener('beforeunload', function(event) {
  if (pontos > 0 || movimentos > 0) {
    event.preventDefault();
    event.returnValue = '';
    return '';
  }
});

// =====================================================
// INICIALIZA√á√ÉO
// =====================================================
novoJogo();

// Exportar fun√ß√µes
window.novoJogo = novoJogo;
window.desfazer = desfazer;
window.mostrarInstrucoes = mostrarInstrucoes;
window.fecharInstrucoes = fecharInstrucoes;
window.mostrarBNCC = mostrarBNCC;
window.fecharBNCC = fecharBNCC;
window.mostrarPainelProfessor = mostrarPainelProfessor;
window.fecharPainelProfessor = fecharPainelProfessor;
window.verificarSenha = verificarSenha;
window.diagnosticar = diagnosticar;
window.gerarCodigo = gerarCodigo;
window.restaurarCodigo = restaurarCodigo;
</script>
</body>
</html>
